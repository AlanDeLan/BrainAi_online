# üèóÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

## üìä –î–≤—ñ —Å–∏—Å—Ç–µ–º–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è

### 1Ô∏è‚É£ **–§–∞–π–ª–æ–≤–∞ —ñ—Å—Ç–æ—Ä—ñ—è** (`history/` –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è)
- **–§–æ—Ä–º–∞—Ç**: JSON —Ñ–∞–π–ª–∏ (`{chat_id}.json`)
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**: –ú–∞—Å–∏–≤ –æ–±'—î–∫—Ç—ñ–≤ –∑ –ø–æ–≤–Ω–æ—é —ñ—Å—Ç–æ—Ä—ñ—î—é —á–∞—Ç—É
- **–ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è**: –ù–∞ Railway Volume (`/app/history`)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—É:**
```json
[
  {
    "user_input": "–¢–µ–∫—Å—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞",
    "archetype": "afina",
    "model_response": "–í—ñ–¥–ø–æ–≤—ñ–¥—å –º–æ–¥–µ–ª—ñ"
  },
  {
    "user_input": "–ù–∞—Å—Ç—É–ø–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è",
    "archetype": "afina",
    "model_response": "–ù–∞—Å—Ç—É–ø–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å"
  }
]
```

**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:**
- ‚úÖ –ü–æ–≤–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–æ–∑–º–æ–≤–∏ (backup)
- ‚úÖ –ï–∫—Å–ø–æ—Ä—Ç/—ñ–º–ø–æ—Ä—Ç —ñ—Å—Ç–æ—Ä—ñ—ó
- ‚úÖ Debugging —Ç–∞ –∞—É–¥–∏—Ç
- ‚úÖ –ö–æ–≤–∑–Ω–µ –≤—ñ–∫–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É (–æ—Å—Ç–∞–Ω–Ω—ñ N –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å)

---

### 2Ô∏è‚É£ **–í–µ–∫—Ç–æ—Ä–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–∏—Ö ChromaDB** (`vector_db_storage/`)
- **–§–æ—Ä–º–∞—Ç**: –í–µ–∫—Ç–æ—Ä–Ω—ñ –µ–º–±–µ–¥–¥—ñ–Ω–≥–∏ + –º–µ—Ç–∞–¥–∞–Ω—ñ
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**: –û–∫—Ä–µ–º—ñ –∫–æ–ª–µ–∫—Ü—ñ—ó –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (`user_{user_id}_chats`)
- **–ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è**: –ù–∞ Railway Volume (`/app/vector_db_storage`)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø–∏—Å—É:**
```python
{
    "id": "chat123_msg_0_user",              # –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    "document": "–¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è",         # –°–∞–º —Ç–µ–∫—Å—Ç
    "embedding": [0.123, 0.456, ...],         # –í–µ–∫—Ç–æ—Ä–Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è
    "metadata": {
        "chat_id": "chat123",                 # ID —á–∞—Ç—É
        "role": "user",                       # user / assistant
        "archetype": "afina",                 # –ê—Ä—Ö–µ—Ç–∏–ø
        "timestamp": "2025-01-14T10:30:00",   # –ß–∞—Å
        "user_id": 1                          # ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    }
}
```

**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:**
- ‚úÖ –°–µ–º–∞–Ω—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫ —Å—Ö–æ–∂–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
- ‚úÖ –ü–æ—à—É–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –∑ —É—Å—ñ—î—ó –±–∞–∑–∏
- ‚úÖ –ü–æ—à—É–∫ —É –ø–æ—Ç–æ—á–Ω—ñ–π —Ä–æ–∑–º–æ–≤—ñ
- ‚úÖ –ü–æ—à—É–∫ —É –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö —Ä–æ–∑–º–æ–≤–∞—Ö
- ‚úÖ –Ü–∑–æ–ª—è—Ü—ñ—è –¥–∞–Ω–∏—Ö –º—ñ–∂ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏

---

## üîÑ –ü—Ä–æ—Ü–µ—Å –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è (–ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –∑–∞–ø–∏—Ç—ñ)

### –ö—Ä–æ–∫ 1: –û–±—Ä–æ–±–∫–∞ –∑–∞–ø–∏—Ç—É (`main.py` ‚Üí `/api/chat`)

```
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ‚Üí text="–ü—Ä–∏–≤—ñ—Ç", archetype="afina", chat_id="abc123", remember=true
```

### –ö—Ä–æ–∫ 2: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –∑ —Ñ–∞–π–ª—É

```python
# main.py, lines 197-213
if remember and chat_id:
    filepath = get_chat_file(chat_id)  # history/abc123.json
    if os.path.exists(filepath):
        chat_history = json.loads(content)  # –ó–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏ —ñ—Å—Ç–æ—Ä—ñ—é
```

**–©–æ –æ—Ç—Ä–∏–º—É—î–º–æ:**
```json
[
  {"user_input": "–°—Ç–∞—Ä–µ –ø–∏—Ç–∞–Ω–Ω—è", "model_response": "–°—Ç–∞—Ä–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å"},
  {"user_input": "–©–µ –ø–∏—Ç–∞–Ω–Ω—è", "model_response": "–©–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å"}
]
```

### –ö—Ä–æ–∫ 3: –û–±—Ä–æ–±–∫–∞ –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (`core/logic.py` ‚Üí `process_with_archetype()`)

```python
# –ü–µ—Ä–µ–¥–∞—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é –∑ —Ñ–∞–π–ª—É
result = process_with_archetype(
    text=text,
    chat_history=chat_history,  # ‚Üê –Ü—Å—Ç–æ—Ä—ñ—è –∑ —Ñ–∞–π–ª—É
    chat_id=chat_id,
    user_id=user_id
)
```

### –ö—Ä–æ–∫ 4: –ü–æ—à—É–∫ —É –≤–µ–∫—Ç–æ—Ä–Ω—ñ–π –±–∞–∑—ñ (–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `process_with_archetype()`)

```python
# core/logic.py, lines 340-410

# 1. –ü–æ—à—É–∫ —É –ü–û–¢–û–ß–ù–û–ú–£ —á–∞—Ç—ñ (continuity)
relevant_messages = search_chat_messages(
    chat_id="abc123", 
    query=text, 
    n_results=3,
    user_id=user_id
)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: 3 –Ω–∞–π–±—ñ–ª—å—à —Å—Ö–æ–∂–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ abc123

# 2. –ü–æ—à—É–∫ —É –í–°–Ü–• —á–∞—Ç–∞—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (broader context)
relevant_chats = search_chats(
    query=text, 
    n_results=3, 
    user_id=user_id
)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: 3 –Ω–∞–π–±—ñ–ª—å—à —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏—Ö —á–∞—Ç–∏/—Ñ–∞–π–ª–∏

# 3. –ö–æ–≤–∑–Ω–µ –≤—ñ–∫–Ω–æ –∑ —Ñ–∞–π–ª–æ–≤–æ—ó —ñ—Å—Ç–æ—Ä—ñ—ó (immediate context)
recent_messages = chat_history[-3:]  # –û—Å—Ç–∞–Ω–Ω—ñ 3 –æ–±–º—ñ–Ω–∏
```

### –ö—Ä–æ–∫ 5: –§–æ—Ä–º—É–≤–∞–Ω–Ω—è –ø–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

```python
# core/logic.py, lines 380-420

context = ""

# –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑ –ø–æ—Ç–æ—á–Ω–æ—ó —Ä–æ–∑–º–æ–≤–∏ (vector DB)
if context_messages:
    context += "Relevant context from this conversation:\n"
    context += "User: –°—Ç–∞—Ä–µ –ø–∏—Ç–∞–Ω–Ω—è\nAssistant: –°—Ç–∞—Ä–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å\n"

# –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑ —ñ–Ω—à–∏—Ö —Ä–æ–∑–º–æ–≤ (vector DB)
if context_chats:
    context += "Relevant context from previous conversations:\n"
    context += "From chat xyz789: –°—Ö–æ–∂–∞ —Ç–µ–º–∞...\n"

# –ö–æ–≤–∑–Ω–µ –≤—ñ–∫–Ω–æ (file history)
recent_messages = [
    {"role": "user", "content": "–û—Å—Ç–∞–Ω–Ω—î –ø–∏—Ç–∞–Ω–Ω—è"},
    {"role": "assistant", "content": "–û—Å—Ç–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—å"}
]
```

### –ö—Ä–æ–∫ 6: –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

```python
# core/logic.py, lines 490-510

model_response = generate_response(
    model, 
    system_prompt=system_prompt,
    user_message=text,
    context=context,              # ‚Üê –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑ vector DB
    conversation_history=recent_messages,  # ‚Üê –ö–æ–≤–∑–Ω–µ –≤—ñ–∫–Ω–æ –∑ —Ñ–∞–π–ª—É
    **model_params
)
```

### –ö—Ä–æ–∫ 7: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —É —Ñ–∞–π–ª

```python
# main.py, lines 240-264

# –î–æ–¥–∞—î–º–æ –¥–æ —ñ—Å—Ç–æ—Ä—ñ—ó
chat_history.append({
    "user_input": text,
    "archetype": archetype,
    "model_response": result["response"]
})

# –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —É —Ñ–∞–π–ª
async with aiofiles.open(filepath, "w") as f:
    await f.write(json.dumps(chat_history, indent=2))
```

**–§–∞–π–ª –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:**
```json
[
  {"user_input": "–°—Ç–∞—Ä–µ –ø–∏—Ç–∞–Ω–Ω—è", "model_response": "–°—Ç–∞—Ä–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å"},
  {"user_input": "–©–µ –ø–∏—Ç–∞–Ω–Ω—è", "model_response": "–©–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å"},
  {"user_input": "–ü—Ä–∏–≤—ñ—Ç", "model_response": "–í—ñ—Ç–∞—é! –ß–∏–º –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏?"}
]
```

### –ö—Ä–æ–∫ 8: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —É –≤–µ–∫—Ç–æ—Ä–Ω—É –±–∞–∑—É

```python
# main.py, lines 268-300

# –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
user_msg_id = f"{chat_id}_msg_{msg_index * 2}_user"
save_message(
    chat_id=chat_id,
    message_id=user_msg_id,
    message_text=text,              # "–ü—Ä–∏–≤—ñ—Ç"
    role="user",
    archetype=archetype,
    timestamp=timestamp,
    user_id=user_id
)

# –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞
assistant_msg_id = f"{chat_id}_msg_{msg_index * 2 + 1}_assistant"
save_message(
    chat_id=chat_id,
    message_id=assistant_msg_id,
    message_text=result["response"],  # "–í—ñ—Ç–∞—é! –ß–∏–º –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏?"
    role="assistant",
    archetype=archetype,
    timestamp=timestamp,
    user_id=user_id
)
```

**ChromaDB –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:**
```
user_1_chats –∫–æ–ª–µ–∫—Ü—ñ—è:
‚îú‚îÄ‚îÄ abc123_msg_0_user: "–°—Ç–∞—Ä–µ –ø–∏—Ç–∞–Ω–Ω—è" [vector] {role: user, chat_id: abc123}
‚îú‚îÄ‚îÄ abc123_msg_1_assistant: "–°—Ç–∞—Ä–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å" [vector] {role: assistant}
‚îú‚îÄ‚îÄ abc123_msg_2_user: "–©–µ –ø–∏—Ç–∞–Ω–Ω—è" [vector]
‚îú‚îÄ‚îÄ abc123_msg_3_assistant: "–©–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å" [vector]
‚îú‚îÄ‚îÄ abc123_msg_4_user: "–ü—Ä–∏–≤—ñ—Ç" [vector] ‚Üê –ù–û–í–ò–ô
‚îî‚îÄ‚îÄ abc123_msg_5_assistant: "–í—ñ—Ç–∞—é!" [vector] ‚Üê –ù–û–í–ò–ô
```

---

## üö´ –î—É–±–ª—é–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö?

### ‚ùå –ù–ï–ú–ê–Ñ –¥—É–±–ª—é–≤–∞–Ω–Ω—è —Ä–æ–ª–µ–π!

**–§–∞–π–ª–æ–≤–∞ —ñ—Å—Ç–æ—Ä—ñ—è:**
- –ó–±–µ—Ä—ñ–≥–∞—î **–ø–∞—Ä–∏** (user_input + model_response)
- –û–¥–∏–Ω –æ–±'—î–∫—Ç = –æ–¥–∏–Ω –æ–±–º—ñ–Ω

**–í–µ–∫—Ç–æ—Ä–Ω–∞ –±–∞–∑–∞:**
- –ó–±–µ—Ä—ñ–≥–∞—î **–æ–∫—Ä–µ–º—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è** (user —ñ assistant)
- –î–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∏ = –æ–¥–∏–Ω –æ–±–º—ñ–Ω

**–¶–µ –ù–ï –¥—É–±–ª—é–≤–∞–Ω–Ω—è**, —Ü–µ —Ä—ñ–∑–Ω—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Ü—ñ–ª–µ–π:

| –ê—Å–ø–µ–∫—Ç | –§–∞–π–ª | Vector DB |
|--------|------|-----------|
| **–§–æ—Ä–º–∞—Ç** | –ü–∞—Ä–∏ –∑–∞–ø–∏—Ç-–≤—ñ–¥–ø–æ–≤—ñ–¥—å | –û–∫—Ä–µ–º—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è |
| **–î–æ—Å—Ç—É–ø** | –ü–æ—Å–ª—ñ–¥–æ–≤–Ω–∏–π (—á–∏—Ç–∞—î–º–æ –≤–µ—Å—å —Ñ–∞–π–ª) | –°–µ–º–∞–Ω—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫ |
| **–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è** | Backup, –µ–∫—Å–ø–æ—Ä—Ç, –∫–æ–≤–∑–Ω–µ –≤—ñ–∫–Ω–æ | –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∏–π –ø–æ—à—É–∫ |
| **–†–æ–∑–º—ñ—Ä** | –í–µ—Å—å —á–∞—Ç | –¢—ñ–ª—å–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∏ |

---

## üéØ –Ø–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

### –°—Ü–µ–Ω–∞—Ä—ñ–π 1: –ü—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è —Ä–æ–∑–º–æ–≤–∏

```
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: "–ê —â–æ —Ç–∏ —Å–∫–∞–∑–∞–ª–∞ –ø—Ä–æ –±—é–¥–∂–µ—Ç?"
```

**–°–∏—Å—Ç–µ–º–∞:**
1. **–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î —Ñ–∞–π–ª** ‚Üí –û—Å—Ç–∞–Ω–Ω—ñ 3 –æ–±–º—ñ–Ω–∏ (–∫–æ–≤–∑–Ω–µ –≤—ñ–∫–Ω–æ)
2. **–®—É–∫–∞—î —É vector DB** ‚Üí "–±—é–¥–∂–µ—Ç" –≤ –ø–æ—Ç–æ—á–Ω–æ–º—É —á–∞—Ç—ñ
3. **–ö–æ–º–±—ñ–Ω—É—î**:
   - –ö–æ–≤–∑–Ω–µ –≤—ñ–∫–Ω–æ: –û—Å—Ç–∞–Ω–Ω—ñ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
   - Vector DB: –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –∑–≥–∞–¥–∫–∞ –ø—Ä–æ –±—é–¥–∂–µ—Ç (–º–æ–∂–µ –±—É—Ç–∏ –Ω–∞ –ø–æ—á–∞—Ç–∫—É —Ä–æ–∑–º–æ–≤–∏)
4. **–í—ñ–¥–ø–æ–≤—ñ–¥–∞—î** –∑ –ø–æ–≤–Ω–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

### –°—Ü–µ–Ω–∞—Ä—ñ–π 2: –ü–µ—Ä–µ—Ö—Ä–µ—Å–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è

```
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: "–Ø–∫ —É –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ä–æ–∑–º–æ–≤—ñ –ø—Ä–æ –ø–æ–¥–∞—Ç–∫–∏?"
```

**–°–∏—Å—Ç–µ–º–∞:**
1. **–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î —Ñ–∞–π–ª** ‚Üí –ü–æ—Ç–æ—á–Ω–∏–π —á–∞—Ç (–ø—É—Å—Ç–∏–π –∞–±–æ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏–π)
2. **–®—É–∫–∞—î —É vector DB** ‚Üí "–ø–æ–¥–∞—Ç–∫–∏" —É –í–°–Ü–• —á–∞—Ç–∞—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
3. **–ó–Ω–∞—Ö–æ–¥–∏—Ç—å** —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏–π —á–∞—Ç xyz789 –∑ –æ–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è–º –ø–æ–¥–∞—Ç–∫—ñ–≤
4. **–í—ñ–¥–ø–æ–≤—ñ–¥–∞—î** –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∑ —ñ–Ω—à–æ—ó —Ä–æ–∑–º–æ–≤–∏

### –°—Ü–µ–Ω–∞—Ä—ñ–π 3: –†–æ–±–æ—Ç–∞ –∑ —Ñ–∞–π–ª–∞–º–∏

```
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤ –¥–æ–∫—É–º–µ–Ω—Ç "–ó–∞–∫–æ–Ω –ø—Ä–æ –ø–æ–¥–∞—Ç–∫–∏.txt"
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: "–©–æ —Ç–∞–º –ø—Ä–æ –ü–î–í?"
```

**–°–∏—Å—Ç–µ–º–∞:**
1. **Vector DB** ‚Üí –ü–æ—à—É–∫ "–ü–î–í" –∑–Ω–∞—Ö–æ–¥–∏—Ç—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∏ –∑ —Ñ–∞–π–ª—É
2. **–í—ñ–¥–ø–æ–≤—ñ–¥–∞—î** –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
3. **–ó–±–µ—Ä—ñ–≥–∞—î** –ø–∏—Ç–∞–Ω–Ω—è —ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —É —Ñ–∞–π–ª + vector DB

---

## üîí –Ü–∑–æ–ª—è—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤

### –§–∞–π–ª–∏
```
history/
‚îú‚îÄ‚îÄ user1_chat1.json
‚îú‚îÄ‚îÄ user1_chat2.json
‚îú‚îÄ‚îÄ user2_chat1.json  ‚Üê –î–æ—Å—Ç—É–ø —Ç—ñ–ª—å–∫–∏ –¥–ª—è user2
‚îî‚îÄ‚îÄ user2_chat2.json
```

### Vector DB
```
ChromaDB:
‚îú‚îÄ‚îÄ user_1_chats ‚Üê –ö–æ–ª–µ–∫—Ü—ñ—è –¥–ª—è user_id=1
‚îÇ   ‚îú‚îÄ‚îÄ chat1_msg_0_user
‚îÇ   ‚îî‚îÄ‚îÄ chat1_msg_1_assistant
‚îî‚îÄ‚îÄ user_2_chats ‚Üê –ö–æ–ª–µ–∫—Ü—ñ—è –¥–ª—è user_id=2 (–û–ö–†–ï–ú–ê!)
    ‚îú‚îÄ‚îÄ chat1_msg_0_user
    ‚îî‚îÄ‚îÄ chat1_msg_1_assistant
```

**–§—É–Ω–∫—Ü—ñ—è `get_user_collection(user_id)`** –∑–∞–≤–∂–¥–∏ –ø–æ–≤–µ—Ä—Ç–∞—î –∫–æ–ª–µ–∫—Ü—ñ—é —Ç—ñ–ª—å–∫–∏ –¥–ª—è —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.

---

## üìà –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è —Ç–æ–∫–µ–Ω—ñ–≤

### –ü—Ä–æ–±–ª–µ–º–∞: –ï–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–µ –∑—Ä–æ—Å—Ç–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

**–ù–∞—ó–≤–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ (–ü–û–ì–ê–ù–û):**
```
–ó–∞–ø–∏—Ç 1: 100 —Ç–æ–∫–µ–Ω—ñ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
–ó–∞–ø–∏—Ç 2: 200 —Ç–æ–∫–µ–Ω—ñ–≤ (–∑–∞–ø–∏—Ç 1 + –∑–∞–ø–∏—Ç 2)
–ó–∞–ø–∏—Ç 3: 300 —Ç–æ–∫–µ–Ω—ñ–≤ (1+2+3)
–ó–∞–ø–∏—Ç 10: 1000 —Ç–æ–∫–µ–Ω—ñ–≤ (1+2+3+...+10)
```

### –†—ñ—à–µ–Ω–Ω—è: –ö–æ–≤–∑–Ω–µ –≤—ñ–∫–Ω–æ + –°–µ–º–∞–Ω—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫

**–ù–∞—à –ø—ñ–¥—Ö—ñ–¥ (–î–û–ë–†–ï):**
```python
MAX_RECENT_MESSAGES = 3  # –û—Å—Ç–∞–Ω–Ω—ñ 3 –æ–±–º—ñ–Ω–∏

# –ó–∞–≤–∂–¥–∏ –±–µ—Ä–µ–º —Ç—ñ–ª—å–∫–∏:
recent_messages = chat_history[-3:]  # –û—Å—Ç–∞–Ω–Ω—ñ 3 (6 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å)

# + –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∏ –∑ vector DB (–Ω–µ –≤—Å—ñ!)
relevant_messages = search_chat_messages(chat_id, query, n_results=3)
relevant_chats = search_chats(query, n_results=3)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ó–∞–≤–∂–¥–∏ ~200-400 —Ç–æ–∫–µ–Ω—ñ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É (–Ω–µ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –¥–æ–≤–∂–∏–Ω–∏ —á–∞—Ç—É!)
- –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞–≤—ñ—Ç—å –∑ –ø–æ—á–∞—Ç–∫—É —Ä–æ–∑–º–æ–≤–∏
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑ —ñ–Ω—à–∏—Ö —Ä–æ–∑–º–æ–≤/—Ñ–∞–π–ª—ñ–≤

---

## üõ°Ô∏è –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å –Ω–∞ Railway

### Railway Volume Configuration

**railway.toml:**
```toml
[[deploy.volumes]]
mountPath = "/app/history"
name = "chat_history"

[[deploy.volumes]]
mountPath = "/app/vector_db_storage"
name = "chromadb_storage"
```

**–©–æ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è:**
- ‚úÖ `/app/history/*.json` ‚Üí –í—Å—ñ —Ñ–∞–π–ª–∏ —á–∞—Ç—ñ–≤
- ‚úÖ `/app/vector_db_storage/chroma.sqlite3` ‚Üí –ë–∞–∑–∞ ChromaDB
- ‚úÖ `/app/vector_db_storage/uuid/*` ‚Üí –ï–º–±–µ–¥–¥—ñ–Ω–≥–∏
- ‚ùå `/app/logs` ‚Üí –ù–ï –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è (–µ—Ñ–µ–º–µ—Ä–Ω–æ)
- ‚ùå `/app/uploads` ‚Üí –ù–ï –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è (—Ç–∏–º—á–∞—Å–æ–≤—ñ —Ñ–∞–π–ª–∏)

**–ü—Ä–∏ —Ä–µ–¥–µ–ø–ª–æ—ó:**
1. Railway –±—É–¥—É—î –Ω–æ–≤–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
2. –ú–æ–Ω—Ç—É—î Volume –¥–æ `/app/history` —Ç–∞ `/app/vector_db_storage`
3. –°—Ç–∞—Ä—ñ –¥–∞–Ω—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ –≤ –Ω–æ–≤–æ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ
4. –ù–æ–≤—ñ –¥–∞–Ω—ñ –¥–æ–¥–∞—é—Ç—å—Å—è –¥–æ —ñ—Å–Ω—É—é—á–∏—Ö

---

## üìù –ü—Ä–∏–∫–ª–∞–¥ –ø–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª—É

### –ó–∞–ø–∏—Ç 1 (–Ω–æ–≤–∏–π —á–∞—Ç)
```
User: "–ü—Ä–∏–≤—ñ—Ç! –†–æ–∑–∫–∞–∂–∏ –ø—Ä–æ –±—é–¥–∂–µ—Ç –£–∫—Ä–∞—ó–Ω–∏"
```

**–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è:**
- `history/chat123.json`: `[{"user_input": "–ü—Ä–∏–≤—ñ—Ç!...", "model_response": "..."}]`
- Vector DB: 2 –¥–æ–∫—É–º–µ–Ω—Ç–∏ (user + assistant)

### –ó–∞–ø–∏—Ç 2 (–ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è)
```
User: "–ê –ø–æ–¥–∞—Ç–∫–∏?"
```

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
- –§–∞–π–ª: –û—Å—Ç–∞–Ω–Ω—ñ–π –æ–±–º—ñ–Ω (–∑–∞–ø–∏—Ç 1)
- Vector DB: –ü–æ—à—É–∫ "–ø–æ–¥–∞—Ç–∫–∏" ‚Üí –º–æ–∂–ª–∏–≤–æ –∑–Ω–∞–π–¥–µ –∑–≥–∞–¥–∫–∏ –∑ –∑–∞–ø–∏—Ç—É 1

**–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è:**
- `history/chat123.json`: `[–∑–∞–ø–∏—Ç1, –∑–∞–ø–∏—Ç2]` (–º–∞—Å–∏–≤ –∑ 2 –µ–ª–µ–º–µ–Ω—Ç—ñ–≤)
- Vector DB: +2 –¥–æ–∫—É–º–µ–Ω—Ç–∏ (4 –≤—Å—å–æ–≥–æ)

### –ó–∞–ø–∏—Ç 10 (–¥–æ–≤–≥–∞ —Ä–æ–∑–º–æ–≤–∞)
```
User: "–©–æ —Ç–∏ –∫–∞–∑–∞–ª–∞ –ø—Ä–æ –±—é–¥–∂–µ—Ç —É –ø–µ—Ä—à–æ–º—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ?"
```

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
- –§–∞–π–ª: –û—Å—Ç–∞–Ω–Ω—ñ 3 –æ–±–º—ñ–Ω–∏ (–∑–∞–ø–∏—Ç–∏ 7, 8, 9)
- Vector DB: –ü–æ—à—É–∫ "–±—é–¥–∂–µ—Ç" ‚Üí –∑–Ω–∞—Ö–æ–¥–∏—Ç—å –∑–∞–ø–∏—Ç 1 (–Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Ü–µ –±—É–ª–æ –¥–∞–≤–Ω–æ!)

**–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è:**
- `history/chat123.json`: `[–∑–∞–ø–∏—Ç1, ..., –∑–∞–ø–∏—Ç10]` (–º–∞—Å–∏–≤ –∑ 10 –µ–ª–µ–º–µ–Ω—Ç—ñ–≤)
- Vector DB: 20 –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ (10 user + 10 assistant)

---

## üéì –í–∏—Å–Ω–æ–≤–∫–∏

### –§–∞–π–ª–æ–≤–∞ —ñ—Å—Ç–æ—Ä—ñ—è:
- **–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: Backup, –µ–∫—Å–ø–æ—Ä—Ç, –∫–æ–≤–∑–Ω–µ –≤—ñ–∫–Ω–æ
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**: –ü–∞—Ä–∏ (user_input + model_response)
- **–î–æ—Å—Ç—É–ø**: –ü–æ—Å–ª—ñ–¥–æ–≤–Ω–∏–π (–≤–µ—Å—å —Ñ–∞–π–ª)
- **–û–±–º–µ–∂–µ–Ω–Ω—è**: –û—Å—Ç–∞–Ω–Ω—ñ N –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å

### –í–µ–∫—Ç–æ—Ä–Ω–∞ –±–∞–∑–∞:
- **–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –°–µ–º–∞–Ω—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**: –û–∫—Ä–µ–º—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –µ–º–±–µ–¥–¥—ñ–Ω–≥–∞–º–∏
- **–î–æ—Å—Ç—É–ø**: –°–µ–º–∞–Ω—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫ (—Å—Ö–æ–∂—ñ—Å—Ç—å)
- **–ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ**: –ü–æ—à—É–∫ –≤ —É—Å—ñ–π —ñ—Å—Ç–æ—Ä—ñ—ó, –ø–µ—Ä–µ—Ö—Ä–µ—Å–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è

### –ù–µ–º–∞—î –¥—É–±–ª—é–≤–∞–Ω–Ω—è!
- **–†—ñ–∑–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏** –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Ü—ñ–ª–µ–π
- **–î–æ–ø–æ–≤–Ω—é—é—Ç—å** –æ–¥–∏–Ω –æ–¥–Ω–æ–≥–æ
- **–û–ø—Ç–∏–º—ñ–∑—É—é—Ç—å** –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤
- **–ó–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è** –Ω–∞ Railway Volume (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å)

### –û–ø—Ç–∏–º–∞–ª—å–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—è:
1. –ö–æ–≤–∑–Ω–µ –≤—ñ–∫–Ω–æ (—Ñ–∞–π–ª) ‚Üí Immediate–∫–æ–Ω—Ç–µ–∫—Å—Ç
2. –°–µ–º–∞–Ω—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫ (vector DB) ‚Üí –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
3. –ö–æ–º–±—ñ–Ω—É–≤–∞–Ω–Ω—è ‚Üí –ü–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –±–µ–∑ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
