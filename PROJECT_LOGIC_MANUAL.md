# üìö –î–µ—Ç–∞–ª—å–Ω–∏–π –º–∞–Ω—É–∞–ª: –õ–æ–≥—ñ–∫–∞ —Ä–æ–±–æ—Ç–∏ BrainAi

**–í–µ—Ä—Å—ñ—è:** 2.0 Production  
**–î–∞—Ç–∞:** 16 –ª–∏—Å—Ç–æ–ø–∞–¥–∞ 2025  
**–ê–≤—Ç–æ—Ä:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞

---

## üìã –ó–º—ñ—Å—Ç

1. [–ó–∞–≥–∞–ª—å–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞](#–∑–∞–≥–∞–ª—å–Ω–∞-–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞)
2. [–ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç–∞ –ø–∞–º'—è—Ç—å](#–∫–æ–Ω—Ç–µ–∫—Å—Ç-—Ç–∞-–ø–∞–º—è—Ç—å)
3. [–Ü—Å—Ç–æ—Ä—ñ—è —á–∞—Ç—ñ–≤](#—ñ—Å—Ç–æ—Ä—ñ—è-—á–∞—Ç—ñ–≤)
4. [–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö](#–±–∞–∑–∞-–¥–∞–Ω–∏—Ö)
5. [–í–µ–∫—Ç–æ—Ä–Ω–∏–π –ø–æ—à—É–∫](#–≤–µ–∫—Ç–æ—Ä–Ω–∏–π-–ø–æ—à—É–∫)
6. [–ü—Ä–æ—Ü–µ—Å –æ–±—Ä–æ–±–∫–∏ –∑–∞–ø–∏—Ç—É](#–ø—Ä–æ—Ü–µ—Å-–æ–±—Ä–æ–±–∫–∏-–∑–∞–ø–∏—Ç—É)
7. [–ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è](#–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è)
8. [–ê—Ä—Ö–µ—Ç–∏–ø–∏ AI](#–∞—Ä—Ö–µ—Ç–∏–ø–∏-ai)
9. [–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è —Ç–æ–∫–µ–Ω—ñ–≤](#–æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è-—Ç–æ–∫–µ–Ω—ñ–≤)
10. [–ü—Ä–∏–∫–ª–∞–¥–∏ –∫–æ–¥—É](#–ø—Ä–∏–∫–ª–∞–¥–∏-–∫–æ–¥—É)

---

## üèóÔ∏è –ó–∞–≥–∞–ª—å–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ —Å–∏—Å—Ç–µ–º–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        –ö–û–†–ò–°–¢–£–í–ê–ß                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                        ‚îÇ HTTP/HTTPS
                        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     FastAPI Backend                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Auth    ‚îÇ  ‚îÇ  Logic   ‚îÇ  ‚îÇ  Cache   ‚îÇ  ‚îÇ Rate Limit ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ (JWT)    ‚îÇ  ‚îÇ (AI)     ‚îÇ  ‚îÇ (Memory) ‚îÇ  ‚îÇ (60/min)   ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ                                 ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ              ‚îÇ                   ‚îÇ             ‚îÇ
        ‚ñº              ‚ñº                   ‚ñº             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL  ‚îÇ ‚îÇ   pgvector   ‚îÇ  ‚îÇ Google   ‚îÇ  ‚îÇ  OpenAI  ‚îÇ
‚îÇ  (Messages)  ‚îÇ ‚îÇ (Embeddings) ‚îÇ  ‚îÇ   AI     ‚îÇ  ‚îÇ   API    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ—Ç—ñ–∫ –¥–∞–Ω–∏—Ö

```
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–≤–æ–¥–∏—Ç—å —Ç–µ–∫—Å—Ç
    ‚Üì
JWT –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
    ‚Üì
Rate limiting –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
    ‚Üì
–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É (Sliding Window + Semantic Search)
    ‚Üì
AI –æ–±—Ä–æ–±–∫–∞ (Google AI / OpenAI)
    ‚Üì
–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ PostgreSQL + pgvector
    ‚Üì
–í—ñ–¥–ø–æ–≤—ñ–¥—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
```

---

## üß† –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç–∞ –ø–∞–º'—è—Ç—å

### 1. –°–∏—Å—Ç–µ–º–∞ –ø–∞–º'—è—Ç—ñ

BrainAi –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **–≥—ñ–±—Ä–∏–¥–Ω—É —Å–∏—Å—Ç–µ–º—É –ø–∞–º'—è—Ç—ñ** –∑ —Ç—Ä—å–æ–º–∞ —Ä—ñ–≤–Ω—è–º–∏:

```python
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              –°–¢–†–£–ö–¢–£–†–ê –ü–ê–ú'–Ø–¢–Ü                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                        ‚îÇ
‚îÇ  1Ô∏è‚É£ SLIDING WINDOW (–ö–æ—Ä–æ—Ç–∫–æ—Å—Ç—Ä–æ–∫–æ–≤–∞ –ø–∞–º'—è—Ç—å)          ‚îÇ
‚îÇ     ‚îî‚îÄ –û—Å—Ç–∞–Ω–Ω—ñ 3 –æ–±–º—ñ–Ω–∏ (MAX_RECENT_MESSAGES = 3)     ‚îÇ
‚îÇ     ‚îî‚îÄ –ó–±–µ—Ä—ñ–≥–∞—î –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—ñ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–æ–∑–º–æ–≤–∏        ‚îÇ
‚îÇ     ‚îî‚îÄ –ó–∞–≤–∂–¥–∏ –ø—Ä–∏—Å—É—Ç–Ω—ñ–π —É –ø—Ä–æ–º–ø—Ç—ñ                     ‚îÇ
‚îÇ                                                        ‚îÇ
‚îÇ  2Ô∏è‚É£ SEMANTIC SEARCH - Current Chat (–°–µ—Ä–µ–¥–Ω—å–æ—Å—Ç—Ä–æ–∫–æ–≤–∞) ‚îÇ
‚îÇ     ‚îî‚îÄ Top 3 –Ω–∞–π—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ—à–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑          ‚îÇ
‚îÇ        –ü–û–¢–û–ß–ù–û–ì–û —á–∞—Ç—É (n_results=3)                    ‚îÇ
‚îÇ     ‚îî‚îÄ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î pgvector –¥–ª—è –ø–æ—à—É–∫—É –ø–æ–¥—ñ–±–Ω–æ—Å—Ç—ñ   ‚îÇ
‚îÇ     ‚îî‚îÄ –î–æ–¥–∞—î—Ç—å—Å—è —è–∫—â–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ—Å—Ç—å > threshold       ‚îÇ
‚îÇ                                                        ‚îÇ
‚îÇ  3Ô∏è‚É£ SEMANTIC SEARCH - Global (–î–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤–∞)          ‚îÇ
‚îÇ     ‚îî‚îÄ Top 2 –Ω–∞–π—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ—à–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑          ‚îÇ
‚îÇ        –£–°–Ü–• —á–∞—Ç—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (n_results=2)           ‚îÇ
‚îÇ     ‚îî‚îÄ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î pgvector –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ—à—É–∫—É  ‚îÇ
‚îÇ     ‚îî‚îÄ –î–æ–¥–∞—î—Ç—å—Å—è —è–∫—â–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ—Å—Ç—å > threshold       ‚îÇ
‚îÇ                                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2. –ê–ª–≥–æ—Ä–∏—Ç–º —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

**–§–∞–π–ª:** `core/logic.py`, —Ñ—É–Ω–∫—Ü—ñ—è `process_with_archetype()`

```python
async def process_with_archetype(
    text: str,
    chat_id: str,
    user_id: int,
    archetype_data: dict
):
    """
    –ö–†–û–ö 1: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è Sliding Window
    ------------------------------------
    –û—Å—Ç–∞–Ω–Ω—ñ 3 –æ–±–º—ñ–Ω–∏ = –æ—Å—Ç–∞–Ω–Ω—ñ 6 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (user + assistant)
    """
    recent_messages = db.query(ChatMessage)\
        .filter(
            ChatMessage.user_id == user_id,
            ChatMessage.chat_id == chat_id
        )\
        .order_by(ChatMessage.message_index.desc())\
        .limit(MAX_RECENT_MESSAGES * 2)\
        .all()
    
    recent_messages.reverse()  # –•—Ä–æ–Ω–æ–ª–æ–≥—ñ—á–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫
    
    """
    –ö–†–û–ö 2: –°–µ–º–∞–Ω—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫ –ø–æ –ø–æ—Ç–æ—á–Ω–æ–º—É —á–∞—Ç—É
    --------------------------------------------
    –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Å—Ö–æ–∂—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ü–û–¢–û–ß–ù–û–á —Ä–æ–∑–º–æ–≤–∏
    """
    relevant_messages = search_chat_messages(
        chat_id=chat_id,
        query_text=text,
        n_results=3,
        user_id=user_id
    )
    
    """
    –ö–†–û–ö 3: –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å–µ–º–∞–Ω—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫
    -------------------------------------
    –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Å—Ö–æ–∂—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –Ü–ù–®–ò–• —Ä–æ–∑–º–æ–≤
    """
    relevant_chats = search_chats(
        query_text=text,
        n_results=2,
        user_id=user_id,
        exclude_chat_id=chat_id  # –í–∏–∫–ª—é—á–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Ç
    )
    
    """
    –ö–†–û–ö 4: –û–±'—î–¥–Ω–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
    -----------------------------
    –§–æ—Ä–º—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π –ø—Ä–æ–º–ø—Ç
    """
    context = {
        "recent": recent_messages,        # 6 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        "current_chat": relevant_messages, # –¥–æ 3 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        "other_chats": relevant_chats      # –¥–æ 2 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
    }
    
    # –ú–∞–∫—Å–∏–º—É–º: 6 + 3 + 2 = 11 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ
```

### 3. –ß–æ–º—É —Å–∞–º–µ —Ç–∞–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞?

#### ‚úÖ –ü–µ—Ä–µ–≤–∞–≥–∏ Sliding Window:

```python
MAX_RECENT_MESSAGES = 3  # –û—Å—Ç–∞–Ω–Ω—ñ 3 –æ–±–º—ñ–Ω–∏

# –ü—Ä–∏–∫–ª–∞–¥ —Ä–æ–∑–º–æ–≤–∏:
# User: "–Ø–∫ —Å–ø—Ä–∞–≤–∏?"
# AI: "–î–æ–±—Ä–µ, –¥—è–∫—É—é!"
# User: "–†–æ–∑–∫–∞–∂–∏ –ø—Ä–æ –ø—Ä–æ–µ–∫—Ç"
# AI: "–ü—Ä–æ–µ–∫—Ç –º–∞—î –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É..."
# User: "–ê –±–∞–∑–∞ –¥–∞–Ω–∏—Ö?"
# AI: "–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö PostgreSQL..."
# User: "–Ø–∫–∞ –≤–µ—Ä—Å—ñ—è?" <-- –ù–û–í–ò–ô –ó–ê–ü–ò–¢
```

**Sliding Window –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å:**
- üë§ User: "–†–æ–∑–∫–∞–∂–∏ –ø—Ä–æ –ø—Ä–æ–µ–∫—Ç"
- ü§ñ AI: "–ü—Ä–æ–µ–∫—Ç –º–∞—î –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É..."
- üë§ User: "–ê –±–∞–∑–∞ –¥–∞–Ω–∏—Ö?"
- ü§ñ AI: "–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö PostgreSQL..."
- üë§ User: "–Ø–∫–∞ –≤–µ—Ä—Å—ñ—è?"
- ü§ñ AI: ??? (–æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è)

**–ß–æ–º—É 3, –∞ –Ω–µ 5 –∞–±–æ 10?**
- ‚úÖ **–ï–∫–æ–Ω–æ–º—ñ—è —Ç–æ–∫–µ–Ω—ñ–≤**: 3 –æ–±–º—ñ–Ω–∏ ‚âà 500-1000 —Ç–æ–∫–µ–Ω—ñ–≤
- ‚úÖ **–ê–∫—Ç—É–∞–ª—å–Ω—ñ—Å—Ç—å**: –ó–±–µ—Ä—ñ–≥–∞—î –ª–∏—à–µ —Å–≤—ñ–∂–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
- ‚úÖ **–®–≤–∏–¥–∫—ñ—Å—Ç—å**: –ú–µ–Ω—à–µ –¥–∞–Ω–∏—Ö –¥–ª—è –æ–±—Ä–æ–±–∫–∏
- ‚ùå –Ø–∫—â–æ 10: –∑–∞–Ω–∞–¥—Ç–æ –±–∞–≥–∞—Ç–æ —Ç–æ–∫–µ–Ω—ñ–≤, –≤—Ç—Ä–∞—Ç–∞ —Ñ–æ–∫—É—Å—É

#### ‚úÖ –ü–µ—Ä–µ–≤–∞–≥–∏ Semantic Search:

```python
# –ü—Ä–∏–∫–ª–∞–¥: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á 2 —Ç–∏–∂–Ω—ñ —Ç–æ–º—É –æ–±–≥–æ–≤–æ—Ä—é–≤–∞–≤ PostgreSQL
# –¢–µ–ø–µ—Ä –ø–∏—Ç–∞—î: "–Ø–∫ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –ë–î?"

# Semantic Search –∑–Ω–∞–π–¥–µ:
relevant_messages = [
    "PostgreSQL –ø–æ—Ç—Ä–µ–±—É—î DATABASE_URL",
    "–Ü–Ω–¥–µ–∫—Å–∏ –ø–æ–∫—Ä–∞—â—É—é—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å",
    "pgvector –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ—à—É–∫—É"
]

# –ù–∞–≤—ñ—Ç—å —è–∫—â–æ —Ü–µ –±—É–ª–æ –≤ —ñ–Ω—à–æ–º—É —á–∞—Ç—ñ!
```

**–ß–æ–º—É 3 + 2, –∞ –Ω–µ 10 + 10?**
- ‚úÖ **–¢–æ—á–Ω—ñ—Å—Ç—å**: –¢–æ–ø-3 = –Ω–∞–π—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ—à—ñ
- ‚úÖ **–ë–∞–ª–∞–Ω—Å**: –ü–æ—Ç–æ—á–Ω–∏–π —á–∞—Ç –≤–∞–∂–ª–∏–≤—ñ—à–∏–π (3) –Ω—ñ–∂ —ñ–Ω—à—ñ (2)
- ‚úÖ **–¢–æ–∫–µ–Ω–∏**: 5 –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å ‚âà 1000 —Ç–æ–∫–µ–Ω—ñ–≤
- ‚ùå –Ø–∫—â–æ 10+10: –≤—Ç—Ä–∞—Ç–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—ñ, —à—É–º —É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ

---

## üìú –Ü—Å—Ç–æ—Ä—ñ—è —á–∞—Ç—ñ–≤

### 1. –ú–æ–¥–µ–ª—å –¥–∞–Ω–∏—Ö

**–§–∞–π–ª:** `core/db_models.py`

```python
class ChatMessage(Base):
    """
    –ö–æ–∂–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É —Å–∏—Å—Ç–µ–º—ñ
    """
    __tablename__ = "chat_messages"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    chat_id = Column(String, nullable=False, index=True)
    
    role = Column(String, nullable=False)  # "user" –∞–±–æ "assistant"
    content = Column(Text, nullable=False)
    
    message_index = Column(Integer, nullable=False)  # –ü–æ—Ä—è–¥–æ–∫ —É —á–∞—Ç—ñ
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # –í–ê–ñ–õ–ò–í–û: –Ü–Ω–¥–µ–∫—Å–∏ –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø–æ—à—É–∫—É
    __table_args__ = (
        Index('idx_chat_user_chat', 'user_id', 'chat_id'),
        Index('idx_chat_user_created', 'user_id', 'created_at'),
    )
```

### 2. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó

**–§–∞–π–ª:** `main_production.py`, endpoint `/api/process`

```python
@app.post("/api/process")
async def process_message(
    request: ProcessRequest,
    current_user_id: int = Depends(get_current_user_id),
    db: Session = Depends(get_db)
):
    """
    –ö–†–û–ö 1: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    """
    user_message = request.text
    chat_id = request.chat_id or str(uuid.uuid4())
    
    """
    –ö–†–û–ö 2: –ó–Ω–∞—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–π message_index
    """
    last_message = db.query(ChatMessage)\
        .filter(
            ChatMessage.user_id == current_user_id,
            ChatMessage.chat_id == chat_id
        )\
        .order_by(ChatMessage.message_index.desc())\
        .first()
    
    next_index = (last_message.message_index + 1) if last_message else 0
    
    """
    –ö–†–û–ö 3: –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    """
    user_msg_db = ChatMessage(
        user_id=current_user_id,
        chat_id=chat_id,
        role="user",
        content=user_message,
        message_index=next_index
    )
    db.add(user_msg_db)
    db.commit()
    
    """
    –ö–†–û–ö 4: AI –æ–±—Ä–æ–±–ª—è—î —Ç–∞ –≥–µ–Ω–µ—Ä—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å
    """
    ai_response = await process_with_archetype(
        text=user_message,
        chat_id=chat_id,
        user_id=current_user_id,
        archetype_data=archetype
    )
    
    """
    –ö–†–û–ö 5: –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å AI
    """
    assistant_msg_db = ChatMessage(
        user_id=current_user_id,
        chat_id=chat_id,
        role="assistant",
        content=ai_response,
        message_index=next_index + 1
    )
    db.add(assistant_msg_db)
    db.commit()
    
    """
    –ö–†–û–ö 6: –ó–±–µ—Ä—ñ–≥–∞—î–º–æ embeddings –¥–ª—è semantic search
    """
    await save_chat_embedding(
        chat_id=chat_id,
        user_id=current_user_id,
        text=user_message,
        role="user"
    )
    await save_chat_embedding(
        chat_id=chat_id,
        user_id=current_user_id,
        text=ai_response,
        role="assistant"
    )
    
    return {"response": ai_response, "chat_id": chat_id}
```

### 3. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó

**Endpoint:** `/api/history/db`

```python
@app.get("/api/history/db")
async def get_db_history(
    chat_id: Optional[str] = None,
    limit: int = 100,
    current_user_id: int = Depends(get_current_user_id),
    db: Session = Depends(get_db)
):
    """
    –ü–æ–≤–µ—Ä—Ç–∞—î —ñ—Å—Ç–æ—Ä—ñ—é –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
    """
    query = db.query(ChatMessage).filter(
        ChatMessage.user_id == current_user_id
    )
    
    # –§—ñ–ª—å—Ç—Ä –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —á–∞—Ç—É (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
    if chat_id:
        query = query.filter(ChatMessage.chat_id == chat_id)
    
    # –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –ø–æ —á–∞—Å—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
    messages = query.order_by(ChatMessage.created_at.asc())\
                    .limit(limit)\
                    .all()
    
    # –ì—Ä—É–ø—É–≤–∞–Ω–Ω—è –ø–æ chat_id
    chats = {}
    for msg in messages:
        if msg.chat_id not in chats:
            chats[msg.chat_id] = []
        chats[msg.chat_id].append({
            "role": msg.role,
            "content": msg.content,
            "created_at": msg.created_at.isoformat()
        })
    
    return {"chats": chats}
```

### 4. –Ü–∑–æ–ª—è—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤

**–ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–û:** –ö–æ–∂–µ–Ω –∑–∞–ø–∏—Ç —Ñ—ñ–ª—å—Ç—Ä—É—î—Ç—å—Å—è –ø–æ `user_id`

```python
# ‚ùå –ü–û–ì–ê–ù–û: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ê –º–æ–∂–µ –±–∞—á–∏—Ç–∏ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ë
messages = db.query(ChatMessage).all()

# ‚úÖ –î–û–ë–†–ï: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –±–∞—á–∏—Ç—å –ª–∏—à–µ —Å–≤–æ—ó –¥–∞–Ω—ñ
messages = db.query(ChatMessage)\
    .filter(ChatMessage.user_id == current_user_id)\
    .all()

# ‚úÖ –î–û–ë–†–ï: –ó –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º —Ñ—ñ–ª—å—Ç—Ä–æ–º –ø–æ chat_id
messages = db.query(ChatMessage)\
    .filter(
        ChatMessage.user_id == current_user_id,
        ChatMessage.chat_id == chat_id
    )\
    .all()
```

**–ì–∞—Ä–∞–Ω—Ç—ñ—è –±–µ–∑–ø–µ–∫–∏:**
1. JWT —Ç–æ–∫–µ–Ω ‚Üí current_user_id (Depends(get_current_user_id))
2. –ö–æ–∂–µ–Ω DB –∑–∞–ø–∏—Ç –º–∞—î `filter(user_id == current_user_id)`
3. PostgreSQL Foreign Key constraints

---

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö

### 1. –°—Ö–µ–º–∞ PostgreSQL

```sql
-- –¢–∞–±–ª–∏—Ü—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- –¢–∞–±–ª–∏—Ü—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
CREATE TABLE chat_messages (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    chat_id VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL,  -- 'user' –∞–±–æ 'assistant'
    content TEXT NOT NULL,
    message_index INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    
    -- –Ü–Ω–¥–µ–∫—Å–∏ –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø–æ—à—É–∫—É
    INDEX idx_chat_user_chat (user_id, chat_id),
    INDEX idx_chat_user_created (user_id, created_at)
);

-- –¢–∞–±–ª–∏—Ü—è –≤–µ–∫—Ç–æ—Ä–Ω–∏—Ö embeddings (pgvector)
CREATE TABLE chat_embeddings (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    chat_id VARCHAR(255) NOT NULL,
    message_id INTEGER REFERENCES chat_messages(id) ON DELETE CASCADE,
    embedding vector(768),  -- pgvector —Ç–∏–ø –¥–∞–Ω–∏—Ö
    text_content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    
    -- –Ü–Ω–¥–µ–∫—Å –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ—à—É–∫—É
    INDEX idx_embeddings_user_chat (user_id, chat_id)
);

-- –Ü–Ω–¥–µ–∫—Å –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ—à—É–∫—É (HNSW - Hierarchical Navigable Small World)
CREATE INDEX idx_embeddings_vector ON chat_embeddings
USING hnsw (embedding vector_cosine_ops);

-- –¢–∞–±–ª–∏—Ü—è —Å–µ—Å—ñ–π
CREATE TABLE user_sessions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    token_hash VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP NOT NULL
);

-- –¢–∞–±–ª–∏—Ü—è –∞—Ä—Ö–µ—Ç–∏–ø—ñ–≤
CREATE TABLE archetypes (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    config JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(user_id, name)
);
```

### 2. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ë–î

**–§–∞–π–ª:** `core/database.py`

```python
class DatabaseManager:
    def __init__(self):
        self.engine = None
        self.SessionLocal = None
        self.Base = Base  # SQLAlchemy declarative_base
    
    def init_db(self, database_url: str):
        """
        –ö–†–û–ö 1: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è engine
        """
        self.engine = create_engine(
            database_url,
            pool_size=5,          # 5 –ø–æ—Å—Ç—ñ–π–Ω–∏—Ö –∑'—î–¥–Ω–∞–Ω—å
            max_overflow=10,      # +10 —Ç–∏–º—á–∞—Å–æ–≤–∏—Ö
            pool_pre_ping=True    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è
        )
        
        """
        –ö–†–û–ö 2: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è session factory
        """
        self.SessionLocal = sessionmaker(
            autocommit=False,
            autoflush=False,
            bind=self.engine
        )
        
        """
        –ö–†–û–ö 3: –í–∫–ª—é—á–µ–Ω–Ω—è pgvector (PostgreSQL)
        """
        if "postgresql" in database_url:
            with self.engine.connect() as conn:
                conn.execute(text("CREATE EXTENSION IF NOT EXISTS vector"))
                conn.commit()
        
        """
        –ö–†–û–ö 4: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—Å—ñ—Ö —Ç–∞–±–ª–∏—Ü—å
        """
        Base.metadata.create_all(bind=self.engine)
        
        """
        –ö–†–û–ö 5: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—ñ–≤
        """
        self._create_indexes()
    
    def _create_indexes(self):
        """
        –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—ñ–≤ –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó
        """
        with self.engine.connect() as conn:
            # –Ü–Ω–¥–µ–∫—Å –¥–ª—è chat_messages
            conn.execute(text("""
                CREATE INDEX IF NOT EXISTS idx_chat_user_chat
                ON chat_messages(user_id, chat_id)
            """))
            
            # –Ü–Ω–¥–µ–∫—Å –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ—à—É–∫—É
            conn.execute(text("""
                CREATE INDEX IF NOT EXISTS idx_embeddings_vector
                ON chat_embeddings
                USING hnsw (embedding vector_cosine_ops)
            """))
            
            conn.commit()
```

### 3. Dependency Injection

**–§–∞–π–ª:** `main_production.py`

```python
def get_db():
    """
    FastAPI Dependency –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è DB session
    """
    if db_manager.SessionLocal is None:
        raise RuntimeError("Database not initialized. Call init_database() first")
    
    db = db_manager.SessionLocal()
    try:
        yield db  # –ü–µ—Ä–µ–¥–∞—î–º–æ session –≤ endpoint
    finally:
        db.close()  # –ó–∞–≤–∂–¥–∏ –∑–∞–∫—Ä–∏–≤–∞—î–º–æ –∑'—î–¥–Ω–∞–Ω–Ω—è

# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ endpoint:
@app.get("/api/history")
async def get_history(
    db: Session = Depends(get_db),  # <-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —ñ–Ω'—î–∫—Ü—ñ—è
    current_user_id: int = Depends(get_current_user_id)
):
    messages = db.query(ChatMessage)\
        .filter(ChatMessage.user_id == current_user_id)\
        .all()
    
    return {"messages": messages}
```

### 4. –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó —Ç–∞ error handling

```python
@app.post("/api/process")
async def process_message(db: Session = Depends(get_db)):
    try:
        # –ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        msg = ChatMessage(content="...")
        db.add(msg)
        
        # –ö—Ä–æ–∫ 2: –û–±—Ä–æ–±–ª—è—î–º–æ AI
        response = await ai_process(msg.content)
        
        # –ö—Ä–æ–∫ 3: –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
        reply = ChatMessage(content=response)
        db.add(reply)
        
        # –ö—Ä–æ–∫ 4: Commit —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
        db.commit()
        
        return {"response": response}
    
    except Exception as e:
        # Rollback –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
        db.rollback()
        logger.error(f"Error processing: {e}")
        
        # –ù–µ —Ñ–µ–π–ª–∏–º–æ –∑–∞–ø–∏—Ç, —è–∫—â–æ —Ç—ñ–ª—å–∫–∏ save –Ω–µ –≤–¥–∞–≤—Å—è
        return {"response": response, "error": "Failed to save"}
```

---

## üîç –í–µ–∫—Ç–æ—Ä–Ω–∏–π –ø–æ—à—É–∫ (pgvector)

### 1. –©–æ —Ç–∞–∫–µ pgvector?

**pgvector** - —Ü–µ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è PostgreSQL –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Ç–∞ –ø–æ—à—É–∫—É –≤–µ–∫—Ç–æ—Ä—ñ–≤ (embeddings).

```python
# –¢–µ–∫—Å—Ç ‚Üí –í–µ–∫—Ç–æ—Ä (embedding)
text = "–Ø–∫ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ PostgreSQL?"
embedding = [0.123, -0.456, 0.789, ...]  # 768 —á–∏—Å–µ–ª

# –ü–æ—à—É–∫ —Å—Ö–æ–∂–∏—Ö —Ç–µ–∫—Å—Ç—ñ–≤
similar_texts = search_similar(embedding)
```

### 2. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è embeddings

**–§–∞–π–ª:** `vector_db/client.py`

```python
from sentence_transformers import SentenceTransformer

# –ú–æ–¥–µ–ª—å –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è embeddings
model = SentenceTransformer('paraphrase-multilingual-mpnet-base-v2')

def create_embedding(text: str) -> List[float]:
    """
    –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î —Ç–µ–∫—Å—Ç —É –≤–µ–∫—Ç–æ—Ä (768 —á–∏—Å–µ–ª)
    """
    embedding = model.encode(text, convert_to_numpy=True)
    return embedding.tolist()  # [0.123, -0.456, ..., 0.789]

# –ü—Ä–∏–∫–ª–∞–¥:
text = "–Ø–∫ –ø—Ä–∞—Ü—é—î –±–∞–∑–∞ –¥–∞–Ω–∏—Ö?"
vector = create_embedding(text)
# [0.0234, -0.1234, 0.5678, ..., -0.9012]  (768 —á–∏—Å–µ–ª)
```

### 3. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ pgvector

```python
async def save_chat_embedding(
    chat_id: str,
    user_id: int,
    text: str,
    role: str,
    message_id: int
):
    """
    –ó–±–µ—Ä—ñ–≥–∞—î embedding —É PostgreSQL
    """
    # –ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä—é—î–º–æ embedding
    embedding_vector = create_embedding(text)
    
    # –ö—Ä–æ–∫ 2: –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ –ë–î
    embedding_record = ChatEmbedding(
        user_id=user_id,
        chat_id=chat_id,
        message_id=message_id,
        embedding=embedding_vector,  # pgvector vector(768)
        text_content=text
    )
    
    db.add(embedding_record)
    db.commit()
```

### 4. –°–µ–º–∞–Ω—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫

**–§–∞–π–ª:** `core/semantic_search.py`

```python
def search_chat_messages(
    chat_id: str,
    query_text: str,
    n_results: int = 3,
    user_id: int = None
) -> List[Dict]:
    """
    –ó–Ω–∞—Ö–æ–¥–∏—Ç—å –Ω–∞–π—Å—Ö–æ–∂—ñ—à—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É –ü–û–¢–û–ß–ù–û–ú–£ —á–∞—Ç—ñ
    """
    # –ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä—é—î–º–æ embedding –∑–∞–ø–∏—Ç—É
    query_embedding = create_embedding(query_text)
    
    # –ö—Ä–æ–∫ 2: –í–µ–∫—Ç–æ—Ä–Ω–∏–π –ø–æ—à—É–∫ (cosine similarity)
    results = db.query(ChatEmbedding)\
        .filter(
            ChatEmbedding.user_id == user_id,
            ChatEmbedding.chat_id == chat_id
        )\
        .order_by(
            ChatEmbedding.embedding.cosine_distance(query_embedding)
        )\
        .limit(n_results)\
        .all()
    
    return [
        {
            "text": r.text_content,
            "message_id": r.message_id,
            "similarity": 1 - cosine_distance(query_embedding, r.embedding)
        }
        for r in results
    ]

def search_chats(
    query_text: str,
    n_results: int = 2,
    user_id: int = None,
    exclude_chat_id: str = None
) -> List[Dict]:
    """
    –ó–Ω–∞—Ö–æ–¥–∏—Ç—å –Ω–∞–π—Å—Ö–æ–∂—ñ—à—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É –í–°–Ü–• —á–∞—Ç–∞—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    """
    query_embedding = create_embedding(query_text)
    
    query = db.query(ChatEmbedding)\
        .filter(ChatEmbedding.user_id == user_id)
    
    # –í–∏–∫–ª—é—á–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Ç
    if exclude_chat_id:
        query = query.filter(ChatEmbedding.chat_id != exclude_chat_id)
    
    results = query\
        .order_by(
            ChatEmbedding.embedding.cosine_distance(query_embedding)
        )\
        .limit(n_results)\
        .all()
    
    return [
        {
            "text": r.text_content,
            "chat_id": r.chat_id,
            "message_id": r.message_id,
            "similarity": 1 - cosine_distance(query_embedding, r.embedding)
        }
        for r in results
    ]
```

### 5. –Ø–∫ –ø—Ä–∞—Ü—é—î cosine similarity?

```python
# –î–≤–∞ –≤–µ–∫—Ç–æ—Ä–∏ (embeddings)
vec1 = [0.5, 0.3, 0.2]  # "–Ø–∫ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –±–∞–∑—É –¥–∞–Ω–∏—Ö?"
vec2 = [0.4, 0.35, 0.25]  # "–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö PostgreSQL"
vec3 = [0.1, 0.9, 0.0]  # "–ü–æ–≥–æ–¥–∞ —Å—å–æ–≥–æ–¥–Ω—ñ"

# Cosine similarity (–≤—ñ–¥ 0 –¥–æ 1, –¥–µ 1 = —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ)
similarity(vec1, vec2) = 0.95  # –î—É–∂–µ —Å—Ö–æ–∂—ñ
similarity(vec1, vec3) = 0.15  # –ù–µ—Å—Ö–æ–∂—ñ

# pgvector –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î cosine distance (–≤—ñ–¥ 0 –¥–æ 2, –¥–µ 0 = —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ)
cosine_distance = 1 - cosine_similarity

# –£ SQL:
SELECT * FROM chat_embeddings
ORDER BY embedding <=> '[0.5, 0.3, 0.2]'  -- <=> = cosine distance
LIMIT 3;
```

---

## ‚öôÔ∏è –ü—Ä–æ—Ü–µ—Å –æ–±—Ä–æ–±–∫–∏ –∑–∞–ø–∏—Ç—É

### –ü–æ–≤–Ω–∏–π lifecycle –∑–∞–ø–∏—Ç—É

```python
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  LIFECYCLE –ó–ê–ü–ò–¢–£                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1Ô∏è‚É£ –û–¢–†–ò–ú–ê–ù–ù–Ø –ó–ê–ü–ò–¢–£
   ‚Üì
   POST /api/process
   {
       "text": "–Ø–∫ –ø—Ä–∞—Ü—é—î –±–∞–∑–∞ –¥–∞–Ω–∏—Ö?",
       "chat_id": "abc123",
       "archetype_id": "afina"
   }

2Ô∏è‚É£ –ê–í–¢–ï–ù–¢–ò–§–Ü–ö–ê–¶–Ü–Ø
   ‚Üì
   JWT —Ç–æ–∫–µ–Ω ‚Üí current_user_id = 5
   Rate limiting: 60 –∑–∞–ø–∏—Ç—ñ–≤/—Ö–≤ ‚úÖ

3Ô∏è‚É£ –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –ö–û–ù–¢–ï–ö–°–¢–£
   ‚Üì
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ A. Sliding Window                  ‚îÇ
   ‚îÇ    ‚îî‚îÄ –û—Å—Ç–∞–Ω–Ω—ñ 3 –æ–±–º—ñ–Ω–∏ (6 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å) ‚îÇ
   ‚îÇ                                    ‚îÇ
   ‚îÇ B. Semantic Search - Current Chat  ‚îÇ
   ‚îÇ    ‚îî‚îÄ Top 3 —Å—Ö–æ–∂—ñ –∑ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —á–∞—Ç—É‚îÇ
   ‚îÇ                                    ‚îÇ
   ‚îÇ C. Semantic Search - Global        ‚îÇ
   ‚îÇ    ‚îî‚îÄ Top 2 —Å—Ö–æ–∂—ñ –∑ —ñ–Ω—à–∏—Ö —á–∞—Ç—ñ–≤   ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

4Ô∏è‚É£ –§–û–†–ú–£–í–ê–ù–ù–Ø –ü–†–û–ú–ü–¢–£
   ‚Üì
   System Prompt (–∞—Ä—Ö–µ—Ç–∏–ø –ê—Ñ—ñ–Ω–∞):
   "–¢–∏ - —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–∏–π –∞—Å–∏—Å—Ç–µ–Ω—Ç..."
   
   Context:
   [Sliding Window + Semantic Search]
   
   User Message:
   "–Ø–∫ –ø—Ä–∞—Ü—é—î –±–∞–∑–∞ –¥–∞–Ω–∏—Ö?"

5Ô∏è‚É£ AI –û–ë–†–û–ë–ö–ê
   ‚Üì
   Google AI API (primary) –∞–±–æ OpenAI (fallback)
   ‚Üì
   Response: "–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö PostgreSQL –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î..."

6Ô∏è‚É£ –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø –í –ë–î
   ‚Üì
   PostgreSQL:
   ‚îú‚îÄ chat_messages: user message
   ‚îú‚îÄ chat_messages: assistant response
   ‚îî‚îÄ chat_embeddings: vectors –¥–ª—è –æ–±–æ—Ö

7Ô∏è‚É£ –í–Ü–î–ü–û–í–Ü–î–¨ –ö–û–†–ò–°–¢–£–í–ê–ß–£
   ‚Üì
   {
       "response": "–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö PostgreSQL...",
       "chat_id": "abc123",
       "stats": {
           "tokens_used": 1234,
           "cache_hit": false
       }
   }
```

### –ö–æ–¥ –ø–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª—É

**–§–∞–π–ª:** `main_production.py`

```python
@app.post("/api/process")
async def process_message(
    request: ProcessRequest,
    current_user_id: int = Depends(get_current_user_id),
    db: Session = Depends(get_db)
):
    """
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    –ö–†–û–ö 1: –í–∞–ª—ñ–¥–∞—Ü—ñ—è –≤—Ö—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    """
    if not request.text or not request.text.strip():
        raise HTTPException(400, "Text cannot be empty")
    
    user_message = request.text.strip()
    chat_id = request.chat_id or str(uuid.uuid4())
    archetype_id = request.archetype_id or "afina"
    
    """
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    –ö–†–û–ö 2: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—Ä—Ö–µ—Ç–∏–ø—É
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    """
    archetype = load_archetype_config(archetype_id, current_user_id)
    if not archetype:
        raise HTTPException(404, "Archetype not found")
    
    """
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    –ö–†–û–ö 3: –ó–Ω–∞—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–π message_index
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    """
    last_message = db.query(ChatMessage)\
        .filter(
            ChatMessage.user_id == current_user_id,
            ChatMessage.chat_id == chat_id
        )\
        .order_by(ChatMessage.message_index.desc())\
        .first()
    
    next_index = (last_message.message_index + 1) if last_message else 0
    
    """
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    –ö–†–û–ö 4: –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    """
    user_msg_db = ChatMessage(
        user_id=current_user_id,
        chat_id=chat_id,
        role="user",
        content=user_message,
        message_index=next_index
    )
    db.add(user_msg_db)
    db.commit()
    db.refresh(user_msg_db)  # –û—Ç—Ä–∏–º—É—î–º–æ ID
    
    """
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    –ö–†–û–ö 5: AI –æ–±—Ä–æ–±–∫–∞ (–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º)
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    """
    try:
        ai_response = await process_with_archetype(
            text=user_message,
            chat_id=chat_id,
            user_id=current_user_id,
            archetype_data=archetype
        )
    except Exception as e:
        logger.error(f"AI processing error: {e}")
        raise HTTPException(500, "AI processing failed")
    
    """
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    –ö–†–û–ö 6: –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å AI
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    """
    assistant_msg_db = ChatMessage(
        user_id=current_user_id,
        chat_id=chat_id,
        role="assistant",
        content=ai_response,
        message_index=next_index + 1
    )
    db.add(assistant_msg_db)
    db.commit()
    db.refresh(assistant_msg_db)
    
    """
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    –ö–†–û–ö 7: –ó–±–µ—Ä—ñ–≥–∞—î–º–æ embeddings –¥–ª—è semantic search
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    """
    try:
        # User message embedding
        await save_chat_embedding(
            chat_id=chat_id,
            user_id=current_user_id,
            text=user_message,
            role="user",
            message_id=user_msg_db.id
        )
        
        # Assistant response embedding
        await save_chat_embedding(
            chat_id=chat_id,
            user_id=current_user_id,
            text=ai_response,
            role="assistant",
            message_id=assistant_msg_db.id
        )
    except Exception as e:
        logger.warning(f"Failed to save embeddings: {e}")
        # –ù–µ —Ñ–µ–π–ª–∏–º–æ –∑–∞–ø–∏—Ç, —è–∫—â–æ embeddings –Ω–µ –∑–±–µ—Ä–µ–≥–ª–∏—Å—è
    
    """
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    –ö–†–û–ö 8: –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    """
    return {
        "response": ai_response,
        "chat_id": chat_id,
        "message_index": next_index + 1,
        "archetype": archetype_id
    }
```

---

## üîê –ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è

### 1. JWT —Ç–æ–∫–µ–Ω–∏

**–§–∞–π–ª:** `core/auth.py`

```python
from jose import jwt, JWTError
from datetime import datetime, timedelta

SECRET_KEY = os.getenv("SECRET_KEY", "your-secret-key-here")
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_DAYS = 7

def create_access_token(data: dict) -> str:
    """
    –°—Ç–≤–æ—Ä—é—î JWT —Ç–æ–∫–µ–Ω
    """
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(days=ACCESS_TOKEN_EXPIRE_DAYS)
    to_encode.update({"exp": expire})
    
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt

# –ü—Ä–∏–∫–ª–∞–¥:
token = create_access_token({"sub": "admin@brainai.local", "user_id": 1})
# eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞

```python
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials

security = HTTPBearer()

async def get_current_user_id(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    db: Session = Depends(get_db)
) -> int:
    """
    Dependency –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è user_id –∑ JWT
    """
    token = credentials.credentials
    
    try:
        # –î–µ–∫–æ–¥—É—î–º–æ JWT
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        email: str = payload.get("sub")
        user_id: int = payload.get("user_id")
        
        if email is None or user_id is None:
            raise HTTPException(401, "Invalid token")
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Å–µ—Å—ñ—è —â–µ –∞–∫—Ç–∏–≤–Ω–∞
        session = db.query(UserSession)\
            .filter(UserSession.token_hash == hash_token(token))\
            .first()
        
        if not session:
            raise HTTPException(401, "Session expired")
        
        if session.expires_at < datetime.utcnow():
            raise HTTPException(401, "Token expired")
        
        return user_id
    
    except JWTError:
        raise HTTPException(401, "Invalid token")

# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:
@app.get("/api/profile")
async def get_profile(current_user_id: int = Depends(get_current_user_id)):
    # current_user_id –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏—Ç—è–≥—É—î—Ç—å—Å—è –∑ JWT
    return {"user_id": current_user_id}
```

### 3. –•–µ—à—É–≤–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—ñ–≤

**Bcrypt –∑ SHA256 pre-hash** (–æ–±—Ö—ñ–¥ 72-byte –ª—ñ–º—ñ—Ç—É bcrypt)

```python
import bcrypt
import hashlib

class User(Base):
    @staticmethod
    def hash_password(password: str) -> str:
        """
        SHA256 ‚Üí bcrypt (–æ–±—Ö—ñ–¥ 72-byte –ª—ñ–º—ñ—Ç—É)
        """
        # –ö—Ä–æ–∫ 1: SHA256 pre-hash
        sha_hash = hashlib.sha256(password.encode()).hexdigest()
        
        # –ö—Ä–æ–∫ 2: bcrypt hash
        bcrypt_hash = bcrypt.hashpw(
            sha_hash.encode(),
            bcrypt.gensalt()
        )
        
        return bcrypt_hash.decode()
    
    def verify_password(self, password: str) -> bool:
        """
        –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
        """
        # –ö—Ä–æ–∫ 1: SHA256 pre-hash
        sha_hash = hashlib.sha256(password.encode()).hexdigest()
        
        # –ö—Ä–æ–∫ 2: –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ bcrypt hash
        return bcrypt.checkpw(
            sha_hash.encode(),
            self.password_hash.encode()
        )

# –ü—Ä–∏–∫–ª–∞–¥:
user = User(email="admin@brainai.local")
user.password_hash = User.hash_password("SecureAdmin2024!")

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:
user.verify_password("SecureAdmin2024!")  # True
user.verify_password("wrong")  # False
```

### 4. Login/Register flow

```python
@app.post("/api/auth/login")
async def login(
    request: LoginRequest,
    db: Session = Depends(get_db)
):
    """
    –ö–†–û–ö 1: –ó–Ω–∞–π—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    """
    user = db.query(User)\
        .filter(User.email == request.email)\
        .first()
    
    if not user:
        raise HTTPException(401, "Invalid credentials")
    
    """
    –ö–†–û–ö 2: –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø–∞—Ä–æ–ª—å
    """
    if not user.verify_password(request.password):
        raise HTTPException(401, "Invalid credentials")
    
    """
    –ö–†–û–ö 3: –°—Ç–≤–æ—Ä–∏—Ç–∏ JWT —Ç–æ–∫–µ–Ω
    """
    access_token = create_access_token({
        "sub": user.email,
        "user_id": user.id
    })
    
    """
    –ö–†–û–ö 4: –ó–±–µ—Ä–µ–≥—Ç–∏ —Å–µ—Å—ñ—é
    """
    session = UserSession(
        user_id=user.id,
        token_hash=hash_token(access_token),
        expires_at=datetime.utcnow() + timedelta(days=7)
    )
    db.add(session)
    db.commit()
    
    """
    –ö–†–û–ö 5: –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ —Ç–æ–∫–µ–Ω
    """
    return {
        "access_token": access_token,
        "token_type": "bearer",
        "expires_in": 7 * 24 * 60 * 60  # 7 –¥–Ω—ñ–≤ —É —Å–µ–∫—É–Ω–¥–∞—Ö
    }
```

---

## üé≠ –ê—Ä—Ö–µ—Ç–∏–ø–∏ AI

### 1. –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∞—Ä—Ö–µ—Ç–∏–ø—É

**–§–∞–π–ª:** `archetypes.yaml`

```yaml
afina:
  name: "–ê—Ñ—ñ–Ω–∞"
  description: "–Ü–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–∏–π –∞—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –Ω–∞–≤—á–∞–Ω–Ω—è —Ç–∞ –Ω–∞—É–∫–æ–≤–æ—ó —Ä–æ–±–æ—Ç–∏"
  
  prompts:
    base: "prompts/afina_base.txt"
    context_instructions: "prompts/afina_context_instructions.txt"
    response_style: "prompts/afina_response_style.txt"
  
  settings:
    temperature: 0.7        # –ö—Ä–µ–∞—Ç–∏–≤–Ω—ñ—Å—Ç—å (0-1)
    max_tokens: 2000        # –ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω—ñ–≤ —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    top_p: 0.9              # Nucleus sampling
    frequency_penalty: 0.5  # –£–Ω–∏–∫–∞—Ç–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω—å
    presence_penalty: 0.3   # –ó–∞–æ—Ö–æ—á—É–≤–∞—Ç–∏ –Ω–æ–≤—ñ —Ç–µ–º–∏

sofiya:
  name: "–°–æ—Ñ—ñ—è"
  description: "–ö—Ä–µ–∞—Ç–∏–≤–Ω–∏–π –∞—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—ñ–≤"
  
  prompts:
    base: "prompts/sofiya_base.txt"
    context_instructions: "prompts/sofiya_context_instructions.txt"
    response_style: "prompts/sofiya_response_style.txt"
  
  settings:
    temperature: 0.9        # –ë—ñ–ª—å—à–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—ñ
    max_tokens: 3000
    top_p: 0.95
    frequency_penalty: 0.7
    presence_penalty: 0.5
```

### 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–º–ø—Ç—ñ–≤

**–§–∞–π–ª:** `prompts/afina_base.txt`

```
–¢–∏ - –ê—Ñ—ñ–Ω–∞, —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–∏–π –∞—Å–∏—Å—Ç–µ–Ω—Ç —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –¥–ª—è –¥–æ–ø–æ–º–æ–≥–∏ —É –Ω–∞–≤—á–∞–Ω–Ω—ñ —Ç–∞ –Ω–∞—É–∫–æ–≤—ñ–π —Ä–æ–±–æ—Ç—ñ.

–¢–í–û–á –ü–†–ò–ù–¶–ò–ü–ò:
1. –¢–æ—á–Ω—ñ—Å—Ç—å —Ç–∞ —Ñ–∞–∫—Ç–∏—á–Ω–∞ –∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å
2. –°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ—Å—Ç—å —Ç–∞ –ª–æ–≥—ñ—á–Ω—ñ—Å—Ç—å –≤–∏–∫–ª–∞–¥—É
3. –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –¥–∂–µ—Ä–µ–ª–∞ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω—ñ –¥–∞–Ω—ñ
4. –°–ø—Ä–æ—â–µ–Ω–Ω—è —Å–∫–ª–∞–¥–Ω–∏—Ö –∫–æ–Ω—Ü–µ–ø—Ü—ñ–π –±–µ–∑ –≤—Ç—Ä–∞—Ç–∏ –∑–º—ñ—Å—Ç—É

–¢–í–û–á –í–ú–Ü–ù–ù–Ø:
- –ê–Ω–∞–ª—ñ–∑ —Ç–∞ —Å–∏–Ω—Ç–µ–∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó
- –ü–æ—è—Å–Ω–µ–Ω–Ω—è —Å–∫–ª–∞–¥–Ω–∏—Ö –∫–æ–Ω—Ü–µ–ø—Ü—ñ–π –ø—Ä–æ—Å—Ç–æ—é –º–æ–≤–æ—é
- –î–æ–ø–æ–º–æ–≥–∞ —É –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è—Ö —Ç–∞ –Ω–∞–ø–∏—Å–∞–Ω–Ω—ñ –Ω–∞—É–∫–æ–≤–∏—Ö —Ä–æ–±—ñ—Ç
- –ö—Ä–∏—Ç–∏—á–Ω–µ –º–∏—Å–ª–µ–Ω–Ω—è —Ç–∞ –ª–æ–≥—ñ—á–Ω–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü—ñ—è

–°–¢–ò–õ–¨ –ö–û–ú–£–ù–Ü–ö–ê–¶–Ü–á:
- –ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π, –∞–ª–µ –¥—Ä—É–∂–Ω—ñ–π
- –°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º —Å–ø–∏—Å–∫—ñ–≤ —Ç–∞ –ø—ñ–¥–∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤
- –ü—Ä–∏–∫–ª–∞–¥–∏ –¥–ª—è —ñ–ª—é—Å—Ç—Ä–∞—Ü—ñ—ó —Å–∫–ª–∞–¥–Ω–∏—Ö —Ç–µ–º
- –ó–∞–ø–∏—Ç–∞–Ω–Ω—è –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–Ω—è, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
```

### 3. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—Ä—Ö–µ—Ç–∏–ø—É

**–§–∞–π–ª:** `core/logic.py`

```python
def load_archetype_config(archetype_id: str, user_id: int) -> dict:
    """
    –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∞—Ä—Ö–µ—Ç–∏–ø—É
    """
    # –°–ø–æ—á–∞—Ç–∫—É —à—É–∫–∞—î–º–æ –∫–∞—Å—Ç–æ–º–Ω–∏–π –∞—Ä—Ö–µ—Ç–∏–ø –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    custom = db.query(Archetype)\
        .filter(
            Archetype.user_id == user_id,
            Archetype.name == archetype_id
        )\
        .first()
    
    if custom:
        return custom.config
    
    # –Ø–∫—â–æ –Ω–µ–º–∞—î –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑ archetypes.yaml
    with open("archetypes.yaml", "r", encoding="utf-8") as f:
        archetypes = yaml.safe_load(f)
    
    if archetype_id not in archetypes:
        return None
    
    config = archetypes[archetype_id]
    
    # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø—Ä–æ–º–ø—Ç–∏ –∑ —Ñ–∞–π–ª—ñ–≤
    config["system_prompt"] = load_prompt_file(
        config["prompts"]["base"]
    )
    config["context_instructions"] = load_prompt_file(
        config["prompts"]["context_instructions"]
    )
    config["response_style"] = load_prompt_file(
        config["prompts"]["response_style"]
    )
    
    return config

def load_prompt_file(filepath: str) -> str:
    """
    –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –ø—Ä–æ–º–ø—Ç—É –∑ —Ñ–∞–π–ª—É
    """
    with open(filepath, "r", encoding="utf-8") as f:
        return f.read()
```

### 4. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ AI –∑–∞–ø–∏—Ç—ñ

```python
async def process_with_archetype(
    text: str,
    chat_id: str,
    user_id: int,
    archetype_data: dict
):
    """
    –ö–†–û–ö 1: –§–æ—Ä–º—É—î–º–æ system prompt
    """
    system_prompt = archetype_data["system_prompt"]
    
    """
    –ö–†–û–ö 2: –î–æ–¥–∞—î–º–æ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó —â–æ–¥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
    """
    context_instructions = archetype_data["context_instructions"]
    
    """
    –ö–†–û–ö 3: –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    """
    recent_messages = load_recent_messages(chat_id, user_id, limit=3)
    relevant_context = search_relevant_context(text, chat_id, user_id)
    
    """
    –ö–†–û–ö 4: –§–æ—Ä–º—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π –ø—Ä–æ–º–ø—Ç
    """
    messages = [
        {
            "role": "system",
            "content": f"{system_prompt}\n\n{context_instructions}"
        },
        # –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑ —ñ—Å—Ç–æ—Ä—ñ—ó
        *[
            {"role": msg.role, "content": msg.content}
            for msg in recent_messages
        ],
        # –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        {
            "role": "system",
            "content": f"–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:\n{relevant_context}"
        },
        # –ü–æ—Ç–æ—á–Ω–∏–π –∑–∞–ø–∏—Ç
        {
            "role": "user",
            "content": text
        }
    ]
    
    """
    –ö–†–û–ö 5: AI –∑–∞–ø–∏—Ç –∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏ –∞—Ä—Ö–µ—Ç–∏–ø—É
    """
    response = await genai_client.generate_content(
        messages=messages,
        temperature=archetype_data["settings"]["temperature"],
        max_tokens=archetype_data["settings"]["max_tokens"],
        top_p=archetype_data["settings"]["top_p"]
    )
    
    return response.text
```

---

## ‚ö° –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è —Ç–æ–∫–µ–Ω—ñ–≤

### 1. –ü—Ä–æ–±–ª–µ–º–∞ –µ–∫—Å–ø–ª–æ–Ω–µ–Ω—Ü—ñ–π–Ω–æ–≥–æ –∑—Ä–æ—Å—Ç–∞–Ω–Ω—è

```python
# ‚ùå –ü–û–ì–ê–ù–û: –ó–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é
all_messages = db.query(ChatMessage)\
    .filter(ChatMessage.chat_id == chat_id)\
    .all()

# –Ø–∫—â–æ —É —á–∞—Ç—ñ 1000 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å:
# 1000 * 200 —Ç–æ–∫–µ–Ω—ñ–≤ = 200,000 —Ç–æ–∫–µ–Ω—ñ–≤
# –õ—ñ–º—ñ—Ç –º–æ–¥–µ–ª—ñ: 32,000 —Ç–æ–∫–µ–Ω—ñ–≤ ‚ùå
```

### 2. Sliding Window Strategy

```python
# ‚úÖ –î–û–ë–†–ï: –¢—ñ–ª—å–∫–∏ –æ—Å—Ç–∞–Ω–Ω—ñ 3 –æ–±–º—ñ–Ω–∏
MAX_RECENT_MESSAGES = 3  # 3 –æ–±–º—ñ–Ω–∏ = 6 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å

recent_messages = db.query(ChatMessage)\
    .filter(ChatMessage.chat_id == chat_id)\
    .order_by(ChatMessage.message_index.desc())\
    .limit(MAX_RECENT_MESSAGES * 2)\  # * 2 –±–æ user + assistant
    .all()

# 6 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å * 200 —Ç–æ–∫–µ–Ω—ñ–≤ = 1,200 —Ç–æ–∫–µ–Ω—ñ–≤ ‚úÖ
```

### 3. Semantic Search Optimization

```python
# ‚úÖ –î–û–ë–†–ï: –¢—ñ–ª—å–∫–∏ –Ω–∞–π—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ—à—ñ
relevant_current = search_chat_messages(
    chat_id=chat_id,
    query_text=text,
    n_results=3  # –¢–æ–ø-3 –∑ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —á–∞—Ç—É
)

relevant_global = search_chats(
    query_text=text,
    n_results=2,  # –¢–æ–ø-2 –∑ —ñ–Ω—à–∏—Ö —á–∞—Ç—ñ–≤
    exclude_chat_id=chat_id
)

# 5 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å * 200 —Ç–æ–∫–µ–Ω—ñ–≤ = 1,000 —Ç–æ–∫–µ–Ω—ñ–≤ ‚úÖ
```

### 4. –ó–∞–≥–∞–ª—å–Ω–∏–π –±—é–¥–∂–µ—Ç —Ç–æ–∫–µ–Ω—ñ–≤

```python
"""
–†–û–ó–ü–û–î–Ü–õ –¢–û–ö–ï–ù–Ü–í (–Ω–∞ –ø—Ä–∏–∫–ª–∞–¥—ñ GPT-4):

–ó–∞–≥–∞–ª—å–Ω–∏–π –ª—ñ–º—ñ—Ç: 8,192 —Ç–æ–∫–µ–Ω–∞

1. System Prompt (–∞—Ä—Ö–µ—Ç–∏–ø):       500 —Ç–æ–∫–µ–Ω—ñ–≤
2. Sliding Window (6 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å): 1,200 —Ç–æ–∫–µ–Ω—ñ–≤
3. Semantic Search (5 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å): 1,000 —Ç–æ–∫–µ–Ω—ñ–≤
4. User Message:                    300 —Ç–æ–∫–µ–Ω—ñ–≤
5. Response Budget:                 2,000 —Ç–æ–∫–µ–Ω—ñ–≤
6. –†–µ–∑–µ—Ä–≤:                          3,192 —Ç–æ–∫–µ–Ω–∞

TOTAL: 5,000 / 8,192 ‚âà 61% –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
"""

def estimate_tokens(text: str) -> int:
    """
    –ü—Ä–∏–±–ª–∏–∑–Ω–∞ –æ—Ü—ñ–Ω–∫–∞ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ–∫–µ–Ω—ñ–≤
    """
    # –ê–Ω–≥–ª—ñ–π—Å—å–∫–∞: ~4 —Å–∏–º–≤–æ–ª–∏ = 1 —Ç–æ–∫–µ–Ω
    # –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞: ~3 —Å–∏–º–≤–æ–ª–∏ = 1 —Ç–æ–∫–µ–Ω (–±—ñ–ª—å—à–µ UTF-8)
    return len(text) // 3

def trim_context_if_needed(messages: List[Dict], max_tokens: int = 5000):
    """
    –û–±—Ä—ñ–∑–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —è–∫—â–æ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–æ –ª—ñ–º—ñ—Ç
    """
    total_tokens = sum(estimate_tokens(m["content"]) for m in messages)
    
    if total_tokens <= max_tokens:
        return messages
    
    # –í–∏–¥–∞–ª—è—î–º–æ –Ω–∞–π—Å—Ç–∞—Ä—ñ—à—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    while total_tokens > max_tokens and len(messages) > 2:
        removed = messages.pop(0)  # –í–∏–¥–∞–ª—è—î–º–æ –Ω–∞–π—Å—Ç–∞—Ä—ñ—à–µ
        total_tokens -= estimate_tokens(removed["content"])
    
    return messages
```

### 5. –ö–µ—à—É–≤–∞–Ω–Ω—è –¥–ª—è –µ–∫–æ–Ω–æ–º—ñ—ó —Ç–æ–∫–µ–Ω—ñ–≤

**–§–∞–π–ª:** `core/cache.py`

```python
from functools import lru_cache
from datetime import datetime, timedelta

class ContextCache:
    def __init__(self, ttl_seconds: int = 300):
        self.cache = {}
        self.ttl = ttl_seconds
    
    def get(self, key: str):
        """
        –û—Ç—Ä–∏–º–∞—Ç–∏ –∑ –∫–µ—à—É
        """
        if key not in self.cache:
            return None
        
        entry = self.cache[key]
        if datetime.now() > entry["expires_at"]:
            del self.cache[key]
            return None
        
        return entry["value"]
    
    def set(self, key: str, value: any):
        """
        –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ –∫–µ—à
        """
        self.cache[key] = {
            "value": value,
            "expires_at": datetime.now() + timedelta(seconds=self.ttl)
        }

# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:
cache = ContextCache(ttl_seconds=300)  # 5 —Ö–≤–∏–ª–∏–Ω

def load_recent_messages(chat_id, user_id):
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–µ—à
    cache_key = f"recent:{chat_id}:{user_id}"
    cached = cache.get(cache_key)
    if cached:
        return cached
    
    # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑ –ë–î
    messages = db.query(ChatMessage)\
        .filter(...)\
        .all()
    
    # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ –∫–µ—à
    cache.set(cache_key, messages)
    return messages
```

---

## üí° –ü—Ä–∏–∫–ª–∞–¥–∏ –∫–æ–¥—É

### –ü—Ä–∏–∫–ª–∞–¥ 1: –ü–æ–≤–Ω–∏–π —Ü–∏–∫–ª —á–∞—Ç—É

```python
"""
–°—Ü–µ–Ω–∞—Ä—ñ–π: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ—á–∏–Ω–∞—î –Ω–æ–≤–∏–π —á–∞—Ç –ø—Ä–æ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è
"""

# 1. Login
response = requests.post("http://localhost:8000/api/auth/login", json={
    "email": "admin@brainai.local",
    "password": "SecureAdmin2024!"
})
token = response.json()["access_token"]
headers = {"Authorization": f"Bearer {token}"}

# 2. –ü–µ—Ä—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—Å—Ç–≤–æ—Ä—é—î –Ω–æ–≤–∏–π —á–∞—Ç)
response = requests.post("http://localhost:8000/api/process", 
    headers=headers,
    json={
        "text": "–ü–æ—è—Å–Ω–∏ —â–æ —Ç–∞–∫–µ REST API",
        "archetype_id": "afina"
    }
)
chat_id = response.json()["chat_id"]
print(response.json()["response"])

# 3. –î—Ä—É–≥–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (–ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è —á–∞—Ç—É)
response = requests.post("http://localhost:8000/api/process",
    headers=headers,
    json={
        "text": "–ê —è–∫ –∑—Ä–æ–±–∏—Ç–∏ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é?",
        "chat_id": chat_id,  # –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ —Ç–æ–π —Å–∞–º–∏–π —á–∞—Ç
        "archetype_id": "afina"
    }
)
print(response.json()["response"])

# 4. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó
response = requests.get(f"http://localhost:8000/api/history/db?chat_id={chat_id}",
    headers=headers
)
history = response.json()["chats"][chat_id]
for msg in history:
    print(f"{msg['role']}: {msg['content'][:50]}...")
```

### –ü—Ä–∏–∫–ª–∞–¥ 2: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∞—Ä—Ö–µ—Ç–∏–ø—É

```python
"""
–°—Ü–µ–Ω–∞—Ä—ñ–π: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å—Ç–≤–æ—Ä—é—î –≤–ª–∞—Å–Ω–æ–≥–æ AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞ –¥–ª—è –∫–æ–¥—É–≤–∞–Ω–Ω—è
"""

custom_archetype = {
    "name": "CodeMentor",
    "description": "–ï–∫—Å–ø–µ—Ä—Ç –∑ Python —Ç–∞ –≤–µ–±-—Ä–æ–∑—Ä–æ–±–∫–∏",
    "system_prompt": """
        –¢–∏ - CodeMentor, –µ–∫—Å–ø–µ—Ä—Ç –∑ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è –Ω–∞ Python.
        
        –¢–≤–æ—ó –∑–∞–≤–¥–∞–Ω–Ω—è:
        1. –ü–∏—Å–∞—Ç–∏ —á–∏—Å—Ç–∏–π, —ñ–¥—ñ–æ–º–∞—Ç–∏—á–Ω–∏–π Python –∫–æ–¥
        2. –ü–æ—è—Å–Ω—é–≤–∞—Ç–∏ —Å–∫–ª–∞–¥–Ω—ñ –∫–æ–Ω—Ü–µ–ø—Ü—ñ—ó –ø—Ä–æ—Å—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏
        3. –î–∞–≤–∞—Ç–∏ –ø—Ä–∏–∫–ª–∞–¥–∏ –∫–æ–¥—É –∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—è–º–∏
        4. –í–∫–∞–∑—É–≤–∞—Ç–∏ –Ω–∞ best practices
        
        –§–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π:
        - –ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å
        - –ü—Ä–∏–∫–ª–∞–¥ –∫–æ–¥—É
        - –ü–æ—è—Å–Ω–µ–Ω–Ω—è
        - –ü—ñ–¥–∫–∞–∑–∫–∏ —â–æ–¥–æ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è
    """,
    "settings": {
        "temperature": 0.5,  # –ú–µ–Ω—à–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—ñ –¥–ª—è –∫–æ–¥—É
        "max_tokens": 2500,
        "top_p": 0.8
    }
}

# –°—Ç–≤–æ—Ä—é—î–º–æ –∞—Ä—Ö–µ—Ç–∏–ø
response = requests.post("http://localhost:8000/api/archetypes",
    headers=headers,
    json=custom_archetype
)

# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–æ–≤–∏–π –∞—Ä—Ö–µ—Ç–∏–ø
response = requests.post("http://localhost:8000/api/process",
    headers=headers,
    json={
        "text": "–Ø–∫ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ JWT –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é?",
        "archetype_id": "CodeMentor"
    }
)
```

### –ü—Ä–∏–∫–ª–∞–¥ 3: –°–µ–º–∞–Ω—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫

```python
"""
–°—Ü–µ–Ω–∞—Ä—ñ–π: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —à—É–∫–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –±–∞–∑—É –¥–∞–Ω–∏—Ö,
—è–∫—É –æ–±–≥–æ–≤–æ—Ä—é–≤–∞–≤ 2 —Ç–∏–∂–Ω—ñ —Ç–æ–º—É
"""

# –ü–æ—Ç–æ—á–Ω–∏–π –∑–∞–ø–∏—Ç
user_query = "–Ø–∫ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —ñ–Ω–¥–µ–∫—Å–∏ PostgreSQL?"

# –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:
# 1. –°—Ç–≤–æ—Ä—é—î embedding –∑–∞–ø–∏—Ç—É
query_embedding = create_embedding(user_query)

# 2. –®—É–∫–∞—î —Å—Ö–æ–∂—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
similar_messages = db.query(ChatEmbedding)\
    .filter(ChatEmbedding.user_id == current_user_id)\
    .order_by(
        ChatEmbedding.embedding.cosine_distance(query_embedding)
    )\
    .limit(5)\
    .all()

# 3. –ó–Ω–∞—Ö–æ–¥–∏—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:
# "PostgreSQL —ñ–Ω–¥–µ–∫—Å–∏ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ"
# "CREATE INDEX idx_name ON table(column)"
# "EXPLAIN ANALYZE –ø–æ–∫–∞–∂–µ —á–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —ñ–Ω–¥–µ–∫—Å"

# 4. –î–æ–¥–∞—î –¥–æ –ø—Ä–æ–º–ø—Ç—É
# AI –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó —Ä–æ–∑–º–æ–≤–∏!
```

---

## üéØ –í–∏—Å–Ω–æ–≤–æ–∫

### –ö–ª—é—á–æ–≤—ñ –ø—Ä–∏–Ω—Ü–∏–ø–∏ BrainAi:

1. **–ì—ñ–±—Ä–∏–¥–Ω–∞ –ø–∞–º'—è—Ç—å**: Sliding Window + Semantic Search
2. **–Ü–∑–æ–ª—è—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤**: user_id —É –∫–æ–∂–Ω–æ–º—É –∑–∞–ø–∏—Ç—ñ
3. **–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è —Ç–æ–∫–µ–Ω—ñ–≤**: –û–±–º–µ–∂–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (3+3+2)
4. **–í–µ–∫—Ç–æ—Ä–Ω–∏–π –ø–æ—à—É–∫**: pgvector –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–Ω–æ–≥–æ –ø–æ—à—É–∫—É
5. **–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π–Ω—ñ—Å—Ç—å**: PostgreSQL + commit/rollback
6. **–ë–µ–∑–ø–µ–∫–∞**: JWT + bcrypt + rate limiting
7. **–ì–Ω—É—á–∫—ñ—Å—Ç—å**: –ê—Ä—Ö–µ—Ç–∏–ø–∏ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤

### –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è:

- ‚úÖ PostgreSQL > SQLite (production)
- ‚úÖ pgvector > FAISS/ChromaDB (—ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ PostgreSQL)
- ‚úÖ JWT > Session cookies (stateless)
- ‚úÖ FastAPI > Flask (async, —à–≤–∏–¥–∫—ñ—Å—Ç—å)
- ‚úÖ Sliding Window > Full history (—Ç–æ–∫–µ–Ω–∏)

### –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:

1. –î–æ–¥–∞—Ç–∏ —Ç–µ—Å—Ç–∏ (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
2. –î–æ–¥–∞—Ç–∏ WebSocket –¥–ª—è streaming
3. –î–æ–¥–∞—Ç–∏ Redis –¥–ª—è –∫–µ—à—É–≤–∞–Ω–Ω—è
4. –†–æ–∑—à–∏—Ä–∏—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏ —Ç–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
5. –î–æ–¥–∞—Ç–∏ support –¥–ª—è —Ñ–∞–π–ª—ñ–≤ (PDF, DOCX)

---

**–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** 16 –ª–∏—Å—Ç–æ–ø–∞–¥–∞ 2025  
**–í–µ—Ä—Å—ñ—è:** 2.0 Production  
**–ê–≤—Ç–æ—Ä:** BrainAi Development Team
