# Виправлення проблеми з портом при перезапуску сервера

## Проблема

При перезапуску сервера часто виникала помилка "Port 8000 is already in use". Це відбувалося через:

1. Порт не звільнявся після завершення сервера
2. TCP TIME_WAIT стан після закриття з'єднань
3. Неповне graceful shutdown
4. Недостатня перевірка порту перед запуском

## Рішення

### 1. Створено модуль управління портами (`core/port_manager.py`)

**Функції:**
- `is_port_in_use()` - перевіряє, чи порт зайнятий (з урахуванням TIME_WAIT)
- `check_port_time_wait()` - перевіряє, чи порт в стані TIME_WAIT
- `get_processes_on_port()` - отримує список процесів на порту (Windows/Linux/Mac)
- `kill_process_on_port()` - завершує процеси на порту
- `ensure_port_free()` - гарантує, що порт вільний перед запуском

**Особливості:**
- Підтримка Windows, Linux, Mac
- Обробка TIME_WAIT стану
- Автоматичне завершення процесів
- Очікування звільнення порту (до 15 секунд)
- Детальне логування операцій

### 2. Покращено graceful shutdown в `main.py`

**Покращення:**
- Більше часу на graceful shutdown (до 5 секунд)
- Правильне закриття з'єднань перед завершенням
- Додаткове очікування перед exit для звільнення порту
- Детальне логування процесу shutdown

**Зміни:**
- Збільшено час очікування graceful shutdown з 2 до 5 секунд
- Додано цикл очікування з перевіркою стану сервера
- Додано додаткове очікування після shutdown для звільнення порту
- Покращено логування процесу shutdown

### 3. Покращено перевірку порту в `run_app_exe.py`

**Покращення:**
- Використання нового модуля `port_manager`
- Автоматична перевірка та звільнення порту перед запуском
- Обробка помилок з детальними повідомленнями
- Fallback функції, якщо модуль недоступний

**Зміни:**
- Замінено прості функції на `ensure_port_free()` з `port_manager`
- Додано детальні повідомлення про помилки
- Додано обробку TIME_WAIT стану
- Додано fallback функції для сумісності

### 4. Оновлено збірку (`run_app.spec`)

**Зміни:**
- Додано `core.port_manager` до hiddenimports
- Модуль включається в exe збірку

## Результат

### До виправлення:
- Порт не звільнявся після завершення
- Помилка "Port 8000 is already in use" при перезапуску
- Потрібно було чекати 30-120 секунд між перезапусками
- Потрібно було вручну завершувати процеси

### Після виправлення:
- Порт автоматично звільняється перед запуском
- Автоматичне завершення процесів на порту
- Обробка TIME_WAIT стану
- Швидкий перезапуск без помилок
- Детальне логування для діагностики

## Використання

### Автоматично

Порт перевіряється та звільняється автоматично при запуску сервера через `run_app_exe.py`.

### Вручну

```python
from core.port_manager import ensure_port_free

# Звільнити порт перед запуском
if ensure_port_free(8000, max_wait=15):
    print("Port is free, ready to start server")
else:
    print("Port could not be freed, please wait or restart")
```

## Тестування

1. Запустіть сервер
2. Завершіть його через API (`/api/shutdown`) або Ctrl+C
3. Одразу спробуйте перезапустити
4. Порт повинен бути звільнений автоматично

## Логування

Всі операції з портами логуються:
- `logger.debug()` - детальна інформація про перевірки
- `logger.info()` - важливі події (звільнення порту, shutdown)
- `logger.warning()` - попередження (не вдалося завершити процес)
- `logger.error()` - помилки

## Діагностика

Якщо проблеми продовжуються:

1. Перевірте логи (`logs/local_brain.log`)
2. Використайте `get_processes_on_port(8000)` для діагностики
3. Перевірте, чи порт в TIME_WAIT стані
4. Спробуйте інший порт у `config.yaml`
5. Перезавантажте систему (останній варіант)

## Документація

Детальна документація доступна в `PORT_MANAGEMENT.md`.

