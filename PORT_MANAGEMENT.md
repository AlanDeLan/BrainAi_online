# Управління портами в Local Brain

## Проблема

При перезапуску сервера часто виникає помилка "Port 8000 is already in use". Це відбувається через:

1. **TCP TIME_WAIT стан**: Після закриття з'єднання порт залишається в стані TIME_WAIT (30-120 секунд)
2. **Неповне закриття з'єднань**: Сервер може не закрити всі з'єднання перед завершенням
3. **Процес не завершується**: Процес сервера може залишатися активним

## Рішення

### 1. Модуль управління портами (`core/port_manager.py`)

Створено спеціальний модуль для управління портами:

- **`is_port_in_use()`**: Перевіряє, чи порт зайнятий (з урахуванням TIME_WAIT)
- **`check_port_time_wait()`**: Перевіряє, чи порт в стані TIME_WAIT
- **`get_processes_on_port()`**: Отримує список процесів, що використовують порт
- **`kill_process_on_port()`**: Завершує процеси, що використовують порт
- **`ensure_port_free()`**: Гарантує, що порт вільний перед запуском

### 2. Покращений graceful shutdown

У `main.py` покращено процес завершення сервера:

- Більше часу на graceful shutdown (до 5 секунд)
- Правильне закриття з'єднань перед завершенням
- Додаткове очікування перед exit для звільнення порту

### 3. Перевірка порту перед запуском

У `run_app_exe.py`:

- Автоматична перевірка порту перед запуском
- Автоматичне завершення процесів, що використовують порт
- Очікування звільнення порту (до 15 секунд)
- Обробка TIME_WAIT стану

## Використання

### Автоматично

Порт перевіряється та звільняється автоматично при запуску сервера через `run_app_exe.py`.

### Вручну

```python
from core.port_manager import ensure_port_free, get_processes_on_port

# Перевірити процеси на порту
processes = get_processes_on_port(8000)
print(f"Processes on port 8000: {processes}")

# Звільнити порт
if ensure_port_free(8000, max_wait=15):
    print("Port is free!")
else:
    print("Port could not be freed")
```

## Налаштування

### Таймаути

- `max_wait`: Максимальний час очікування звільнення порту (за замовчуванням 15 секунд)
- Graceful shutdown: До 5 секунд на закриття з'єднань
- Додаткове очікування: 1 секунда перед exit

### SO_REUSEADDR

Модуль використовує `SO_REUSEADDR` опцію для сокету, що дозволяє:

- Повторне використання порту після закриття
- Обхід TIME_WAIT стану (частково)
- Швидший перезапуск сервера

## Обмеження

1. **TIME_WAIT**: Порт може залишатися в TIME_WAIT стані до 120 секунд (залежить від ОС)
2. **Права доступу**: Для завершення процесів можуть знадобитися права адміністратора
3. **Інші програми**: Якщо порт використовує інша програма, вона може не завершитися

## Рекомендації

1. **Використовуйте graceful shutdown**: Завжди використовуйте кнопку "Завершити сеанс" або правильне завершення процесу
2. **Чекайте між перезапусками**: Якщо порт в TIME_WAIT, зачекайте кілька секунд
3. **Перевіряйте процеси**: Використовуйте `get_processes_on_port()` для діагностики
4. **Використовуйте інший порт**: Якщо проблеми продовжуються, змініть порт у `config.yaml`

## Діагностика

### Перевірити процеси на порту

```python
from core.port_manager import get_processes_on_port
processes = get_processes_on_port(8000)
for proc in processes:
    print(f"PID: {proc['pid']}, Name: {proc['name']}")
```

### Перевірити стан порту

```python
from core.port_manager import is_port_in_use, check_port_time_wait

if is_port_in_use(8000):
    if check_port_time_wait(8000):
        print("Port is in TIME_WAIT state")
    else:
        print("Port is truly in use")
else:
    print("Port is free")
```

### Windows (PowerShell)

```powershell
# Знайти процеси на порту 8000
Get-NetTCPConnection -LocalPort 8000 | Select-Object OwningProcess, State

# Завершити процес
Stop-Process -Id <PID> -Force
```

### Linux/Mac

```bash
# Знайти процеси на порту 8000
lsof -i :8000

# Завершити процес
kill -9 <PID>
```

## Логування

Модуль `port_manager` використовує логування для відстеження операцій:

- `logger.debug()`: Детальна інформація про перевірки
- `logger.info()`: Важливі події (звільнення порту)
- `logger.warning()`: Попередження (не вдалося завершити процес)
- `logger.error()`: Помилки

## Тестування

Для тестування звільнення порту:

1. Запустіть сервер
2. Завершіть його через API або Ctrl+C
3. Одразу спробуйте перезапустити
4. Порт повинен бути звільнений автоматично

Якщо проблеми продовжуються:

1. Перевірте логи (`logs/local_brain.log`)
2. Використайте діагностичні функції
3. Спробуйте інший порт
4. Перезавантажте систему (останній варіант)

